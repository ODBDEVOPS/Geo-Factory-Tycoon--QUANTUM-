<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Geo‚ÄëFactory Tycoon 8.0 ‚Äì Flux, Biomes & Tech</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
    --topbar-height:60px;
    --bottombar-height:90px;
}
body{
    margin:0;
    background:#05070a;
    color:#e5e5e5;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    overflow:hidden;
}
#game-root{
    position:relative;
    width:100vw;
    height:100vh;
    display:flex;
    background:radial-gradient(circle at top,#1b2333 0,#05070a 55%);
}

/* GRID STABLE */
#grid-container{
    flex:1;
    position:relative;
    display:grid;
    background:#141820;
    border-left:2px solid #252b3a;
    border-right:2px solid #252b3a;
    margin-top:var(--topbar-height);
    margin-bottom:var(--bottombar-height);
}
.cell{
    border:1px solid #1f2533;
    background:#10141c;
    cursor:pointer;
    transition:background .08s,box-shadow .08s,transform .08s;
}
.cell:hover{
    background:#1b2230;
    box-shadow:inset 0 0 6px rgba(0,0,0,.6);
}

/* MACHINE VISIBILITY SAFE */
.module{
    position:relative;
    background:linear-gradient(135deg,#37474f,#263238);
    border:1px solid #546e7a;
}
.module::after{
    content:attr(data-icon);
    position:absolute;
    inset:auto 2px 2px auto;
    font-size:14px;
    opacity:.9;
}

/* EXEMPLES STYLES SP√âCIFIQUES */
.module.extracteur_quantique{background:linear-gradient(135deg,#2e7d32,#66bb6a);}
.module.generateur_plasma{background:linear-gradient(135deg,#e64a19,#ff7043);}
.module.convoyeur_quantique{background:#303f9f;}
.module.convoyeur_quantique::before{
    content:"";
    position:absolute;
    inset:0;
    background:repeating-linear-gradient(
        90deg,
        rgba(255,255,255,.15) 0,
        rgba(255,255,255,.15) 6px,
        transparent 6px,
        transparent 12px
    );
    animation:conveyor-move .35s linear infinite;
    mix-blend-mode:screen;
}
@keyframes conveyor-move{
    from{background-position:0 0}
    to{background-position:12px 0}
}
.animated-machine{
    animation:pulse 1.2s infinite ease-in-out;
}
@keyframes pulse{
    0%{filter:brightness(1)}
    50%{filter:brightness(1.4)}
    100%{filter:brightness(1)}
}

/* MODES D‚ÄôAFFICHAGE (Flux / Pollution / Maintenance) */
.cell.mode-flux-low{box-shadow:inset 0 0 6px rgba(0,188,212,.4);}
.cell.mode-flux-mid{box-shadow:inset 0 0 10px rgba(0,188,212,.7);}
.cell.mode-flux-high{box-shadow:inset 0 0 14px rgba(0,188,212,1);}
.cell.mode-pollution-low{background:#102018;}
.cell.mode-pollution-mid{background:#3e2723;}
.cell.mode-pollution-high{background:#b71c1c;}
.cell.mode-maint-low{border-color:#2e7d32;}
.cell.mode-maint-mid{border-color:#fbc02d;}
.cell.mode-maint-high{border-color:#c62828;}

/* TOP BAR */
#top-bar{
    position:absolute;
    top:0;
    left:50%;
    transform:translateX(-50%);
    max-width:980px;
    width:94%;
    height:var(--topbar-height);
    background:rgba(5,7,12,.85);
    border-radius:999px;
    border:1px solid #283040;
    box-shadow:0 0 10px rgba(0,0,0,.6);
    padding:4px 10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    z-index:20;
}
#top-scroll{
    display:flex;
    gap:10px;
    align-items:center;
    overflow-x:auto;
    white-space:nowrap;
    flex:1;
}
.top-item{
    display:inline-flex;
    align-items:center;
    gap:4px;
    font-size:12px;
    padding:2px 6px;
    border-radius:999px;
    background:#151a24;
    border:1px solid #39425a;
    cursor:pointer;
    transition:background .08s,transform .08s;
}
.top-item span.icon{font-size:14px;}
.top-item:hover{
    background:#1f2634;
    transform:translateY(-1px);
}
#top-menu-btn{
    margin-left:8px;
    width:30px;
    height:30px;
    border-radius:50%;
    border:1px solid #3a4258;
    background:radial-gradient(circle at 30% 20%,#26a69a,#004d40);
    color:#fff;
    font-size:18px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    flex-shrink:0;
}

/* HUD BAS */
#hud-bottom{
    position:absolute;
    bottom:0;
    left:50%;
    transform:translateX(-50%);
    width:70%;
    max-width:780px;
    background:rgba(5,7,12,.9);
    border-radius:12px 12px 0 0;
    padding:8px 16px 10px;
    border:1px solid #283040;
    box-shadow:0 0 12px rgba(0,0,0,.6);
    font-size:13px;
    z-index:10;
    min-height:var(--bottombar-height);
}
.hud-row{
    display:flex;
    justify-content:space-between;
    margin:2px 0;
}
#xp-bar-container{
    width:100%;
    height:10px;
    border-radius:999px;
    background:#151a24;
    overflow:hidden;
    margin-top:4px;
}
#xp-bar{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,#42a5f5,#ab47bc);
}
#market-mini{margin-top:4px;font-size:11px;color:#b0bec5;}
#quest-mini{margin-top:4px;font-size:11px;color:#c5e1a5;}
#biome-mini{margin-top:4px;font-size:11px;color:#80deea;}

/* OVERLAYS G√âN√âRIQUES */
.overlay{
    position:absolute;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:30;
}
.overlay-backdrop{
    position:absolute;
    inset:0;
    background:rgba(0,0,0,.6);
}
.overlay-content{
    position:relative;
    min-width:260px;
    max-width:420px;
    background:#151a24;
    border-radius:12px;
    border:1px solid #3a4258;
    padding:16px 18px;
    box-shadow:0 0 18px rgba(0,0,0,.8);
    z-index:1;
    font-size:13px;
}
.overlay-content h2{margin:0 0 10px;font-size:16px;}
.module-btn{
    width:100%;
    margin:6px 0;
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #39425a;
    background:#1f2634;
    color:#e0e0e0;
    cursor:pointer;
    text-align:left;
    font-size:13px;
}
.module-btn span{float:right;color:#90caf9;}
.module-btn:hover{background:#283144;}
.overlay-close{
    margin-top:8px;
    width:100%;
    padding:6px 0;
    border-radius:8px;
    border:1px solid #455a64;
    background:#263238;
    color:#eceff1;
    cursor:pointer;
}

/* NOTIFS */
#level-up-notification{
    position:absolute;
    top:40%;
    left:50%;
    transform:translate(-50%,-50%) scale(0.8);
    padding:20px 30px;
    background:rgba(255,215,0,.15);
    border:2px solid rgba(255,215,0,.6);
    border-radius:12px;
    color:#ffd700;
    font-size:24px;
    font-weight:bold;
    text-shadow:0 0 10px #ffd700;
    opacity:0;
    pointer-events:none;
    transition:opacity .4s ease,transform .4s ease;
    z-index:9999;
}
#level-up-notification.show{
    opacity:1;
    transform:translate(-50%,-50%) scale(1);
}
#event-toast{
    position:absolute;
    bottom:var(--bottombar-height);
    right:16px;
    max-width:260px;
    background:rgba(33,33,33,.95);
    border-radius:10px;
    border:1px solid #455a64;
    padding:8px 10px;
    font-size:12px;
    box-shadow:0 0 10px rgba(0,0,0,.7);
    opacity:0;
    transform:translateY(10px);
    transition:opacity .25s ease,transform .25s ease;
    z-index:40;
}
#event-toast.show{
    opacity:1;
    transform:translateY(0);
}

/* MENU GLOBAL */
#mobile-menu-panel{
    position:absolute;
    top:var(--topbar-height);
    right:10px;
    background:rgba(5,7,12,.95);
    border-radius:10px;
    border:1px solid #283040;
    padding:6px 8px;
    display:none;
    z-index:25;
}
.mobile-menu-btn{
    display:flex;
    align-items:center;
    gap:6px;
    padding:4px 6px;
    border-radius:6px;
    border:1px solid #39425a;
    background:#151a24;
    color:#e0e0e0;
    font-size:12px;
    cursor:pointer;
    margin:2px 0;
}
.mobile-menu-btn span.icon{font-size:16px;}

/* TOOLTIP HOLOGRAPHIQUE */
@keyframes holoShift {
    0% { background-position:0% 50%; }
    50% { background-position:100% 50%; }
    100% { background-position:0% 50%; }
}
#machine-tooltip {
    position:fixed;
    pointer-events:none;
    background:linear-gradient(135deg,rgba(0,255,255,0.18),rgba(0,150,255,0.28),rgba(0,255,200,0.18));
    background-size:200% 200%;
    animation:holoShift 4s ease-in-out infinite;
    border:1px solid rgba(0,255,255,0.7);
    padding:8px 12px;
    border-radius:10px;
    font-size:12px;
    color:#e5f9ff;
    box-shadow:0 0 12px rgba(0,255,255,0.6);
    z-index:99999;
    display:none;
    max-width:230px;
    line-height:1.35;
    backdrop-filter:blur(6px);
}
#machine-tooltip .title {
    font-weight:bold;
    margin-bottom:4px;
    color:#b3e5fc;
    text-shadow:0 0 6px rgba(0,255,255,0.7);
}
#machine-tooltip .row {
    display:flex;
    justify-content:space-between;
}
#machine-tooltip strong {
    color:#e1f5fe;
}

/* TECH TREE HOLOGRAPHIQUE VERTICAL */
#tech-overlay .overlay-content{
    max-width:520px;
    background:radial-gradient(circle at top,#061018,#02060a);
    border:1px solid rgba(0,255,255,0.4);
    box-shadow:0 0 20px rgba(0,255,255,0.4);
}
#tech-tree-container{
    max-height:420px;
    overflow-y:auto;
    padding-right:6px;
}
.tech-branch{
    margin-bottom:12px;
    padding:8px;
    border-radius:10px;
    background:linear-gradient(180deg,rgba(0,255,255,0.08),rgba(0,0,0,0.4));
    border:1px solid rgba(0,255,255,0.25);
}
.tech-branch-title{
    font-size:13px;
    text-transform:uppercase;
    letter-spacing:1px;
    color:#80deea;
    margin-bottom:6px;
}
.tech-node{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:6px 8px;
    margin:4px 0;
    border-radius:8px;
    background:rgba(0,20,30,0.9);
    border:1px solid rgba(0,255,255,0.25);
}
.tech-node.locked{opacity:0.4;}
.tech-node .left{
    display:flex;
    align-items:center;
    gap:6px;
}
.tech-node .icon{
    width:22px;
    height:22px;
    border-radius:50%;
    background:radial-gradient(circle at 30% 20%,#00e5ff,#006064);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:14px;
    box-shadow:0 0 8px rgba(0,255,255,0.7);
}
.tech-node button{
    font-size:11px;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid #00e5ff;
    background:rgba(0,150,255,0.2);
    color:#e0f7fa;
    cursor:pointer;
}
.tech-node button:disabled{opacity:0.4;cursor:default;}

/* UPGRADE & MODULES */
#upgrade-overlay .overlay-content{max-width:360px;}
.upgrade-stat-row{
    display:flex;
    justify-content:space-between;
    font-size:12px;
    margin:2px 0;
}
.upgrade-modules{
    margin-top:8px;
    padding:6px;
    border-radius:8px;
    background:#10151f;
    border:1px solid #283040;
}
.module-slot{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:26px;
    height:26px;
    border-radius:50%;
    border:1px dashed #455a64;
    margin-right:4px;
    font-size:14px;
    cursor:pointer;
}
.module-slot.filled{
    border-style:solid;
    border-color:#00e5ff;
    box-shadow:0 0 6px rgba(0,229,255,0.7);
}
#module-select-overlay .overlay-content{max-width:360px;}

/* BIOMES OVERLAY */
#biome-overlay .overlay-content{max-width:360px;}

/* MOBILE */
@media(max-width:768px){
    #hud-bottom{
        bottom:0;
        left:0;
        transform:none;
        width:100%;
        border-radius:10px 10px 0 0;
        padding:6px 10px 8px;
        font-size:11px;
    }
    #xp-bar-container{height:8px;}
    #market-mini,#quest-mini,#biome-mini{font-size:10px;}
    .overlay-content{width:90%;max-width:none;}
    #top-bar{width:96%;padding:3px 6px;}
    #top-scroll{-webkit-overflow-scrolling:touch;}
    .top-item{font-size:11px;padding:2px 5px;}
}
</style>
</head>
<body>
<div id="game-root">

    <div id="level-up-notification">Niveau +1 !</div>
    <div id="event-toast"></div>

    <!-- TOP BAR -->
    <div id="top-bar">
        <div id="top-scroll">
            <div class="top-item" id="top-resources">
                <span class="icon">‚öôÔ∏è</span><span id="top-matter">0.0</span>
                <span class="icon">‚ö°</span><span id="top-energy">0.0</span>
                <span class="icon">üíé</span><span id="top-refined">0.0</span>
                <span class="icon">üóëÔ∏è</span><span id="top-waste">0.0</span>
            </div>
            <div class="top-item" id="top-economy">
                <span class="icon">üí∞</span><span id="top-money">0</span>
            </div>
            <div class="top-item" id="top-state">
                <span class="icon">‚ò£Ô∏è</span><span id="top-pollution">0.0</span>
                <span class="icon">üõ†Ô∏è</span><span id="top-maintenance">100%</span>
            </div>
            <div class="top-item" id="top-quest">
                <span class="icon">üéØ</span><span id="top-quest-label">Objectif</span>
            </div>
            <div class="top-item" id="top-tech">
                <span class="icon">üß¨</span><span>Tech</span>
            </div>
            <div class="top-item" id="top-modes">
                <span class="icon">üëÅÔ∏è</span><span id="mode-label">Mode: Normal</span>
            </div>
            <div class="top-item" id="top-biome">
                <span class="icon">üåç</span><span id="top-biome-label">Biome: Temp√©r√©</span>
            </div>
        </div>
        <button id="top-menu-btn">‚ò∞</button>
    </div>

    <!-- HUD BAS -->
    <div id="hud-bottom">
        <div class="hud-row">
            <span>üîº Niveau : <span id="level">1</span></span>
            <span>‚≠ê XP : <span id="xp">0</span> / <span id="xp-next">20</span></span>
            <span>üèÖ Prestige : <span id="prestige">0</span></span>
        </div>
        <div id="xp-bar-container"><div id="xp-bar"></div></div>
        <div id="market-mini">
            March√© : ‚öôÔ∏è <span id="price-matter">10</span> | ‚ö° <span id="price-energy">5</span> | üíé <span id="price-refined">25</span>
        </div>
        <div id="quest-mini">
            üéØ Objectif actuel : <span id="quest-mini-text">Place un extracteur et un g√©n√©rateur.</span>
        </div>
        <div id="biome-mini">
            üåç Biome actuel : <span id="biome-mini-text">Temp√©r√© (√©quilibr√©)</span>
        </div>
    </div>

    <!-- MENU GLOBAL -->
    <div id="mobile-menu-panel">
        <div class="mobile-menu-btn" id="mmarket"><span class="icon">üíπ</span><span>March√©</span></div>
        <div class="mobile-menu-btn" id="mstats"><span class="icon">üìä</span><span>Stats</span></div>
        <div class="mobile-menu-btn" id="mquests"><span class="icon">üéØ</span><span>Qu√™tes</span></div>
        <div class="mobile-menu-btn" id="mhelp"><span class="icon">‚ùî</span><span>Aide</span></div>
        <div class="mobile-menu-btn" id="mtech"><span class="icon">üß¨</span><span>Technologies</span></div>
        <div class="mobile-menu-btn" id="mview"><span class="icon">üëÅÔ∏è</span><span>Modes d‚Äôaffichage</span></div>
        <div class="mobile-menu-btn" id="mbiome"><span class="icon">üåç</span><span>Biomes</span></div>
    </div>

    <!-- OVERLAYS -->
    <div class="overlay" id="build-overlay">
        <div class="overlay-backdrop"></div>
        <div class="overlay-content">
            <h2>Placer un module</h2>
            <button class="overlay-close" id="build-overlay-close">Annuler</button>
        </div>
    </div>

    <div class="overlay" id="market-overlay">
        <div class="overlay-backdrop"></div>
        <div class="overlay-content">
            <h2>March√© Boursier</h2>
            <p>Les prix fluctuent avec le temps. Vendez vos ressources au bon moment.</p>
            <div class="hud-row"><span>‚öôÔ∏è Mati√®re</span><span id="market-matter">10</span></div>
            <div class="hud-row"><span>‚ö° √ânergie</span><span id="market-energy">5</span></div>
            <div class="hud-row"><span>üíé Raffin√©e</span><span id="market-refined">25</span></div>
            <div style="margin-top:10px;">
                <button class="module-btn" id="sell-matter">Vendre 10 ‚öôÔ∏è</button>
                <button class="module-btn" id="sell-energy">Vendre 10 ‚ö°</button>
                <button class="module-btn" id="sell-refined">Vendre 5 üíé</button>
            </div>
            <button class="overlay-close" id="market-overlay-close">Fermer</button>
        </div>
    </div>

    <div class="overlay" id="stats-overlay">
        <div class="overlay-backdrop"></div>
        <div class="overlay-content">
            <h2>Statistiques avanc√©es</h2>
            <div class="hud-row"><span>Prod. ‚öôÔ∏è</span><span id="stat-prod-matter">0/s</span></div>
            <div class="hud-row"><span>Prod. ‚ö°</span><span id="stat-prod-energy">0/s</span></div>
            <div class="hud-row"><span>Prod. üíé</span><span id="stat-prod-refined">0/s</span></div>
            <div class="hud-row"><span>Recherche</span><span id="stat-research">0/s</span></div>
            <div class="hud-row"><span>√âv√©nements</span><span id="stat-events">0</span></div>
            <button class="overlay-close" id="stats-overlay-close">Fermer</button>
        </div>
    </div>

    <div class="overlay" id="quest-overlay">
        <div class="overlay-backdrop"></div>
        <div class="overlay-content">
            <h2>Qu√™tes & Objectifs</h2>
            <ul id="quest-list" style="margin:4px 0 0;padding-left:18px;"></ul>
            <button class="overlay-close" id="quest-overlay-close">Fermer</button>
        </div>
    </div>

    <div class="overlay" id="help-overlay">
        <div class="overlay-backdrop"></div>
        <div class="overlay-content">
            <h2>Tutoriel rapide</h2>
            <ul style="padding-left:18px;margin-top:4px;">
                <li>Clique sur une case vide pour placer un module.</li>
                <li>Clique sur une machine pour l‚Äôam√©liorer et g√©rer ses modules.</li>
                <li>Les laboratoires g√©n√®rent des points de recherche pour l‚Äôarbre technologique.</li>
                <li>Les biomes modifient les bonus/malus de production.</li>
                <li>Utilise les modes Flux / Pollution / Maintenance pour analyser ta grille.</li>
            </ul>
            <button class="overlay-close" id="help-overlay-close">Fermer</button>
        </div>
    </div>

    <div class="overlay" id="info-overlay">
        <div class="overlay-backdrop"></div>
        <div class="overlay-content">
            <h2 id="info-title">Infos</h2>
            <div id="info-body"></div>
            <button class="overlay-close" id="info-overlay-close">Fermer</button>
        </div>
    </div>

    <div class="overlay" id="tech-overlay">
        <div class="overlay-backdrop"></div>
        <div class="overlay-content">
            <h2>Arbre Technologique</h2>
            <div style="font-size:12px;margin-bottom:6px;">
                Points de recherche : <span id="tech-research-points">0</span>
            </div>
            <div id="tech-tree-container"></div>
            <button class="overlay-close" id="tech-overlay-close">Fermer</button>
        </div>
    </div>

    <div class="overlay" id="upgrade-overlay">
        <div class="overlay-backdrop"></div>
        <div class="overlay-content">
            <h2 id="upgrade-title">Am√©liorer la machine</h2>
            <div id="upgrade-body"></div>
            <button class="overlay-close" id="upgrade-overlay-close">Fermer</button>
        </div>
    </div>

    <div class="overlay" id="module-select-overlay">
        <div class="overlay-backdrop"></div>
        <div class="overlay-content">
            <h2>Modules d‚Äôam√©lioration</h2>
            <div id="module-select-body"></div>
            <button class="overlay-close" id="module-select-overlay-close">Fermer</button>
        </div>
    </div>

    <div class="overlay" id="biome-overlay">
        <div class="overlay-backdrop"></div>
        <div class="overlay-content">
            <h2>Biomes</h2>
            <p style="font-size:12px;margin-bottom:6px;">Chaque biome modifie la production, la pollution et certains b√¢timents.</p>
            <div id="biome-select-body"></div>
            <button class="overlay-close" id="biome-overlay-close">Fermer</button>
        </div>
    </div>

    <!-- GRILLE -->
    <div id="grid-container"></div>

    <!-- TOOLTIP -->
    <div id="machine-tooltip"></div>
</div>

<script>
/* ===================== CONFIG GLOBALE ===================== */

const GRID_COLS=10;
const GRID_ROWS=6;
const TICK_MS=200; // moteur 5 fois / seconde (10x plus l√©ger que frame-by-frame)

const BIOMES={
    temperate:{
        id:"temperate",
        name:"Temp√©r√©",
        desc:"√âquilibr√©, sans bonus ni malus majeurs.",
        prodMultiplier:1,
        energyMultiplier:1,
        pollutionMultiplier:1
    },
    desert:{
        id:"desert",
        name:"D√©sert",
        desc:"√ânergie solaire ++, pollution ++.",
        prodMultiplier:1,
        energyMultiplier:1.3,
        pollutionMultiplier:1.2
    },
    forest:{
        id:"forest",
        name:"For√™t",
        desc:"Pollution --, production l√©g√®rement r√©duite.",
        prodMultiplier:0.9,
        energyMultiplier:0.9,
        pollutionMultiplier:0.7
    },
    ice:{
        id:"ice",
        name:"Glace",
        desc:"Production lente mais stable.",
        prodMultiplier:0.8,
        energyMultiplier:1,
        pollutionMultiplier:0.9
    },
    volcano:{
        id:"volcano",
        name:"Volcan",
        desc:"√ânergie ++, risques ++.",
        prodMultiplier:1.1,
        energyMultiplier:1.4,
        pollutionMultiplier:1.3
    }
};
let currentBiome=BIOMES.temperate;

/* ===================== MACHINES ===================== */

const MACHINE_TEMPLATES={
    producer:{hasInput:false,hasOutput:true,template:"producer"},
    processor:{hasInput:true,hasOutput:true,template:"processor"},
    transport:{hasInput:true,hasOutput:true,template:"transport"},
    storage:{hasInput:true,hasOutput:true,template:"storage"},
    amplifier:{hasInput:false,hasOutput:false,template:"amplifier"},
    research:{hasInput:false,hasOutput:true,template:"research"},
    environmental:{hasInput:false,hasOutput:false,template:"environmental"},
    event:{hasInput:false,hasOutput:false,template:"event"},
    special:{hasInput:false,hasOutput:false,template:"special"}
};

const MACHINES={
    extracteur_quantique:{
        id:"extracteur_quantique",
        name:"Extracteur Quantique",
        icon:"‚õèÔ∏è",
        tier:1,
        template:"producer",
        type:"producteur",
        cost:{energy:5,money:10},
        inputs:{},
        outputs:{matter:1.2},
        pollution:0.08,
        maintenanceLossPerHour:3,
        ports:["south","east"],
        description:"Extrait la mati√®re brute.",
        requiresTech:null
    },
    generateur_plasma:{
        id:"generateur_plasma",
        name:"G√©n√©rateur √† Plasma",
        icon:"‚ö°",
        tier:1,
        template:"producer",
        type:"producteur",
        cost:{matter:5,money:8},
        inputs:{matter:0.6},
        outputs:{energy:2.4},
        pollution:0.25,
        maintenanceLossPerHour:5,
        ports:["north","west"],
        description:"Convertit la mati√®re en √©nergie.",
        requiresTech:null
    },
    convoyeur_quantique:{
        id:"convoyeur_quantique",
        name:"Convoyeur Quantique",
        icon:"‚û°Ô∏è",
        tier:2,
        template:"transport",
        type:"transporteur",
        cost:{energy:3,money:5},
        inputs:{},
        outputs:{},
        pollution:0.02,
        maintenanceLossPerHour:2,
        ports:["north","south","east","west"],
        description:"Transport directionnel configurable.",
        requiresTech:"log_convoyeur_rapide"
    },
    silo_stockage:{
        id:"silo_stockage",
        name:"Silo de Stockage",
        icon:"üì¶",
        tier:2,
        template:"storage",
        type:"stockage",
        cost:{money:20},
        inputs:{},
        outputs:{},
        pollution:0,
        maintenanceLossPerHour:1,
        capacity:{matter:200,energy:100,refined:50},
        description:"Stockage local prioritaire.",
        requiresTech:"prod_extraction_ii"
    },
    panneau_solaire:{
        id:"panneau_solaire",
        name:"Panneau Solaire",
        icon:"‚òÄÔ∏è",
        tier:2,
        template:"producer",
        type:"producteur",
        cost:{money:25},
        inputs:{},
        outputs:{energy:1.4},
        pollution:0,
        maintenanceLossPerHour:1,
        description:"√ânergie propre, boost√©e en d√©sert.",
        requiresTech:"ener_generateur_ii"
    },
    raffinerie_avancee:{
        id:"raffinerie_avancee",
        name:"Raffinerie Avanc√©e",
        icon:"üè≠",
        tier:3,
        template:"processor",
        type:"processeur",
        cost:{energy:20,money:40},
        inputs:{matter:3,energy:0.8},
        outputs:{refined:2},
        pollution:0.7,
        maintenanceLossPerHour:7,
        description:"Raffine la mati√®re en ressource premium.",
        requiresTech:"prod_raffinerie_avancee"
    },
    laboratoire_recherche:{
        id:"laboratoire_recherche",
        name:"Laboratoire de Recherche",
        icon:"üî¨",
        tier:3,
        template:"research",
        type:"recherche",
        cost:{energy:15,money:40},
        inputs:{energy:1},
        outputs:{research:0.4},
        pollution:0.15,
        maintenanceLossPerHour:4,
        description:"G√©n√®re des points de recherche.",
        requiresTech:"prod_extraction_iii"
    },
    purificateur_ecologique:{
        id:"purificateur_ecologique",
        name:"Purificateur √âcologique",
        icon:"üå±",
        tier:3,
        template:"environmental",
        type:"environnemental",
        cost:{energy:10,money:50},
        inputs:{},
        outputs:{pollution_reduction:1.5},
        pollution:-0.8,
        maintenanceLossPerHour:3,
        description:"R√©duit la pollution globale.",
        requiresTech:"env_purificateur_ii"
    },
    ordinateur_quantique:{
        id:"ordinateur_quantique",
        name:"Ordinateur Quantique",
        icon:"üíª",
        tier:4,
        template:"amplifier",
        type:"amplificateur",
        cost:{energy:40,money:80},
        inputs:{},
        outputs:{},
        pollution:0.05,
        maintenanceLossPerHour:5,
        special:{radius:2,multiplier:1.6},
        description:"Boost la production autour.",
        requiresTech:"log_teleporteur"
    }
};

const MACHINE_GROUPS={
    tier1:["extracteur_quantique","generateur_plasma"],
    tier2:["convoyeur_quantique","silo_stockage","panneau_solaire"],
    tier3:["raffinerie_avancee","laboratoire_recherche","purificateur_ecologique"],
    tier4:["ordinateur_quantique"]
};

function getMachineDef(id){return MACHINES[id];}

/* ===================== TECH TREE (ALTERNATIVES INCLUSES) ===================== */

const TECHS=[
    {
        id:"prod_extraction_ii",
        branch:"Production",
        icon:"‚õèÔ∏è",
        name:"Extraction II",
        desc:"+15% production des extracteurs, d√©bloque Silo.",
        cost:40,
        requires:[],
        unlocksMachines:["silo_stockage"],
        bonuses:{extracteur_quantique:{prod:0.15}}
    },
    {
        id:"prod_extraction_iii",
        branch:"Production",
        icon:"‚õèÔ∏è",
        name:"Extraction III",
        desc:"+20% production des extracteurs, d√©bloque Laboratoire.",
        cost:70,
        requires:["prod_extraction_ii"],
        unlocksMachines:["laboratoire_recherche"],
        bonuses:{extracteur_quantique:{prod:0.2}}
    },
    {
        id:"prod_raffinerie_avancee",
        branch:"Production",
        icon:"üè≠",
        name:"Raffinerie avanc√©e",
        desc:"D√©bloque la Raffinerie avanc√©e.",
        cost:80,
        requires:["prod_extraction_iii"],
        unlocksMachines:["raffinerie_avancee"],
        bonuses:{}
    },
    {
        id:"ener_generateur_ii",
        branch:"√ânergie",
        icon:"‚ö°",
        name:"G√©n√©rateur II",
        desc:"+15% √©nergie, d√©bloque Panneau solaire.",
        cost:50,
        requires:[],
        unlocksMachines:["panneau_solaire"],
        bonuses:{generateur_plasma:{prod:0.15}}
    },
    {
        id:"log_convoyeur_rapide",
        branch:"Logistique",
        icon:"‚û°Ô∏è",
        name:"Convoyeur rapide",
        desc:"D√©bloque le Convoyeur quantique.",
        cost:35,
        requires:[],
        unlocksMachines:["convoyeur_quantique"],
        bonuses:{convoyeur_quantique:{speed:0.3}}
    },
    {
        id:"log_teleporteur",
        branch:"Logistique",
        icon:"üåÄ",
        name:"T√©l√©porteur",
        desc:"D√©bloque l‚ÄôOrdinateur quantique, +10% vitesse transport.",
        cost:110,
        requires:["log_convoyeur_rapide"],
        unlocksMachines:["ordinateur_quantique"],
        bonuses:{transport:{speed:0.1}}
    },
    {
        id:"env_purificateur_ii",
        branch:"Environnement",
        icon:"üå±",
        name:"Purificateur II",
        desc:"D√©bloque le Purificateur √©cologique.",
        cost:60,
        requires:[],
        unlocksMachines:["purificateur_ecologique"],
        bonuses:{}
    },
    {
        id:"alt_overclock",
        branch:"Alternatives",
        icon:"üî•",
        name:"Overclock",
        desc:"+25% production globale, +25% pollution.",
        cost:90,
        requires:["prod_raffinerie_avancee"],
        unlocksMachines:[],
        bonuses:{global:{prod:0.25,pollution:0.25}},
        exclusiveGroup:"alt_prod"
    },
    {
        id:"alt_stable",
        branch:"Alternatives",
        icon:"üßä",
        name:"Stabilit√©",
        desc:"-20% pollution, -10% production.",
        cost:90,
        requires:["prod_raffinerie_avancee"],
        unlocksMachines:[],
        bonuses:{global:{prod:-0.1,pollution:-0.2}},
        exclusiveGroup:"alt_prod"
    }
];

let unlockedTechs=new Set(["base"]);
let techBonuses={
    perMachine:{},
    global:{pollution:0,prod:0,extraModuleSlot:0},
    transport:{speed:0}
};
let exclusiveTechGroups={}; // group -> chosen id

/* ===================== MODULES AVANC√âS ===================== */

const MODULE_TYPES={
    speed:{id:"speed",icon:"‚è©",name:"Vitesse",desc:"+20% production",effects:{prod:0.2}},
    eco:{id:"eco",icon:"üçÉ",name:"√âcologie",desc:"-20% pollution",effects:{pollution:-0.2}},
    maint:{id:"maint",icon:"üîß",name:"Maintenance",desc:"+30% dur√©e avant panne",effects:{maintenance:0.3}},
    storage:{id:"storage",icon:"üì¶",name:"Stockage",desc:"+50% buffer interne",effects:{storage:0.5}},
    hyperflux:{id:"hyperflux",icon:"‚ö°",name:"Hyperflux",desc:"+40% production, +20% pollution",effects:{prod:0.4,pollution:0.2}},
    cryo:{id:"cryo",icon:"‚ùÑÔ∏è",name:"Cryo‚Äëstabilit√©",desc:"-40% pannes, -10% prod",effects:{failure:-0.4,prod:-0.1}}
};

/* ===================== √âTAT GLOBAL ===================== */

let level=1,prestige=0;
let gridCells=[],cellState=[];
const resources={matter:0,energy:0,refined:0,waste:0,research:0};
let money=50;
let pollutionGlobal=0,maintenanceGlobal=100;
let xp=0,xpNext=20;
const market={
    matter:{price:10,volatility:0.2},
    energy:{price:5,volatility:0.15},
    refined:{price:25,volatility:0.25}
};
let statProdMatter=0,statProdEnergy=0,statProdRefined=0,statResearch=0,statEvents=0;
let gameTime=0,lastSurvivalBonusTime=-999;
let productionZeroTimer=0;
let currentViewMode="normal"; // normal / flux / pollution / maintenance

/* QU√äTES */
const QUESTS=[
    {
        id:"q1",
        text:"Place un extracteur et un g√©n√©rateur.",
        condition:state=>state.count.extracteur_quantique>=1 && state.count.generateur_plasma>=1,
        reward:{xp:15,money:30},
        done:false
    },
    {
        id:"q2",
        text:"Atteins 50 ‚öôÔ∏è et 30 ‚ö°.",
        condition:state=>state.resources.matter>=50 && state.resources.energy>=30,
        reward:{xp:25,money:40},
        done:false
    },
    {
        id:"q3",
        text:"Construis un silo et une raffinerie.",
        condition:state=>state.count.silo_stockage>=1 && state.count.raffinerie_avancee>=1,
        reward:{xp:40,money:60},
        done:false
    },
    {
        id:"q4",
        text:"R√©duis la pollution globale sous 5.",
        condition:state=>state.pollutionGlobal<5,
        reward:{xp:50,money:80,prestige:1},
        done:false
    },
    {
        id:"q_secours",
        text:"Reconstruis un extracteur pour relancer la production.",
        condition:state=>state.count.extracteur_quantique>=1,
        reward:{xp:20,money:20},
        done:false,
        emergency:true
    }
];
let currentQuestIndex=0;

/* GRILLE & √âTAT CELLULES */

const gridContainer=document.getElementById("grid-container");

function createEmptyCellState(){
    return{
        machineId:null,
        maintenance:100,
        pollutionLocal:0,
        broken:false,
        buffer:{},
        level:1,
        modules:[],
        dir:"east", // pour convoyeurs
        fluxLastTick:0
    };
}

function buildGrid(){
    gridContainer.innerHTML="";
    gridContainer.style.gridTemplateColumns=`repeat(${GRID_COLS},1fr)`;
    gridContainer.style.gridTemplateRows=`repeat(${GRID_ROWS},1fr)`;
    gridCells=[];
    const oldState=cellState.slice();
    cellState=[];
    const total=GRID_COLS*GRID_ROWS;
    for(let i=0;i<total;i++){
        const cell=document.createElement("div");
        cell.classList.add("cell");
        cell.dataset.index=i;
        cellState[i]=oldState[i]||createEmptyCellState();

        cell.addEventListener("click",()=>{
            const st=cellState[i];
            if(st.machineId){
                openUpgradeOverlay(i);
            }else{
                selectedCellIndex=i;
                openBuildOverlay();
            }
        });

        cell.addEventListener("contextmenu",(e)=>{
            e.preventDefault();
            const st=cellState[i];
            if(st.machineId && MACHINES[st.machineId].template==="transport"){
                cycleDirection(st);
                renderViewModes(); // update fl√®ches
            }
        });

        cell.addEventListener("mousemove",(e)=>{
            if(cellState[i].machineId)showMachineTooltip(i,e);
        });
        cell.addEventListener("mouseleave",hideMachineTooltip);

        const st=cellState[i];
        if(st.machineId){
            const m=getMachineDef(st.machineId);
            cell.classList.add("module",st.machineId);
            cell.setAttribute("data-icon",m.icon);
            if(m&&m.template==="transport")cell.style.transform=directionToRotation(st.dir);
            if(m&&m.special&&m.special.animated)cell.classList.add("animated-machine");
        }

        gridContainer.appendChild(cell);
        gridCells.push(cell);
    }
}

/* DIRECTIONS CONVOYEURS */

function cycleDirection(state){
    const dirs=["north","east","south","west"];
    const idx=dirs.indexOf(state.dir);
    state.dir=dirs[(idx+1)%dirs.length];
}
function directionToRotation(dir){
    if(dir==="north")return"rotate(0deg)";
    if(dir==="east")return"rotate(90deg)";
    if(dir==="south")return"rotate(180deg)";
    if(dir==="west")return"rotate(270deg)";
    return"rotate(0deg)";
}
function getNeighborIndex(index,dir){
    const row=Math.floor(index/GRID_COLS);
    const col=index%GRID_COLS;
    if(dir==="west" && col>0)return index-1;
    if(dir==="east" && col<GRID_COLS-1)return index+1;
    if(dir==="north" && row>0)return index-GRID_COLS;
    if(dir==="south" && row<GRID_ROWS-1)return index+GRID_COLS;
    return null;
}

/* BUILD OVERLAY */

const buildOverlay=document.getElementById("build-overlay");
const buildOverlayClose=document.getElementById("build-overlay-close");
let selectedCellIndex=null;

function openBuildOverlay(){populateBuildOverlay();buildOverlay.style.display="flex";}
function closeBuildOverlay(){buildOverlay.style.display="none";selectedCellIndex=null;}
buildOverlayClose.addEventListener("click",closeBuildOverlay);
buildOverlay.querySelector(".overlay-backdrop").addEventListener("click",closeBuildOverlay);

function canAfford(machine){
    if(!machine.cost)return true;
    if(machine.cost.money && money<machine.cost.money)return false;
    for(const r in machine.cost){
        if(r==="money")continue;
        if((resources[r]||0)<machine.cost[r])return false;
    }
    return true;
}
function payCost(machine){
    if(!machine.cost)return;
    if(machine.cost.money)money-=machine.cost.money;
    for(const r in machine.cost){
        if(r==="money")continue;
        resources[r]-=machine.cost[r];
    }
}
function isMachineUnlocked(machine){
    if(!machine.requiresTech)return true;
    return unlockedTechs.has(machine.requiresTech);
}
function placeModule(index,id){
    const state=cellState[index];
    if(state.machineId)return;
    const machine=getMachineDef(id);
    if(!machine)return;
    if(!isMachineUnlocked(machine))return;
    if(!canAfford(machine))return;
    payCost(machine);
    state.machineId=id;
    state.maintenance=100;
    state.pollutionLocal=0;
    state.broken=false;
    state.buffer={};
    state.level=1;
    state.modules=[];
    state.fluxLastTick=0;
    const cell=gridCells[index];
    cell.classList.add("module",id);
    cell.setAttribute("data-icon",machine.icon);
    if(machine.template==="transport")cell.style.transform=directionToRotation(state.dir);
    if(machine&&machine.special&&machine.special.animated)cell.classList.add("animated-machine");
}

function populateBuildOverlay(){
    const container=document.querySelector("#build-overlay .overlay-content");
    container.innerHTML="<h2>Placer un module</h2>";
    for(const groupName in MACHINE_GROUPS){
        const title=document.createElement("div");
        title.textContent=groupName.toUpperCase();
        title.style.marginTop="10px";
        title.style.fontWeight="bold";
        container.appendChild(title);
        MACHINE_GROUPS[groupName].forEach(id=>{
            const m=MACHINES[id];
            if(!m)return;
            const btn=document.createElement("button");
            btn.className="module-btn";
            btn.dataset.module=id;
            const unlocked=isMachineUnlocked(m);
            const affordable=canAfford(m);
            btn.style.opacity=unlocked?(affordable?1:0.5):0.25;
            btn.innerHTML=`${m.icon} ${m.name} <span>T${m.tier}</span>`;
            btn.onclick=()=>{
                if(unlocked && affordable){
                    placeModule(selectedCellIndex,id);
                    closeBuildOverlay();
                }
            };
            container.appendChild(btn);
        });
    }
    const close=document.createElement("button");
    close.className="overlay-close";
    close.textContent="Annuler";
    close.onclick=closeBuildOverlay;
    container.appendChild(close);
}

/* ENVIRONNEMENT & MARCH√â */

function updateMarketPrices(){
    for(const key in market){
        const asset=market[key];
        const delta=(Math.random()-0.5)*asset.volatility*asset.price;
        asset.price=Math.max(1,asset.price+delta);
    }
}
function sellResource(type,amount){
    if(resources[type]<amount)return;
    resources[type]-=amount;
    money+=market[type].price*amount;
}

/* TRANSPORT & STOCKAGE */

function pushToStorageOrWorld(resName,amount){
    let remaining=amount;
    for(let i=0;i<cellState.length;i++){
        const st=cellState[i];
        if(!st.machineId)continue;
        const m=getMachineDef(st.machineId);
        if(!m||m.template!=="storage")continue;
        const cap=m.capacity?.[resName];
        if(!cap)continue;
        const stored=st.buffer[resName]||0;
        const free=cap-stored;
        if(free<=0)continue;
        const move=Math.min(free,remaining);
        st.buffer[resName]=(st.buffer[resName]||0)+move;
        remaining-=move;
        if(remaining<=0)return;
    }
    if(remaining>0){
        resources[resName]=(resources[resName]||0)+remaining;
    }
}

/* NOTIFS */

const levelNotif=document.getElementById("level-up-notification");
function showLevelUpNotification(newLevel){
    levelNotif.textContent="Niveau "+newLevel+" atteint !";
    levelNotif.classList.add("show");
    setTimeout(()=>levelNotif.classList.remove("show"),2000);
}
const eventToast=document.getElementById("event-toast");
let eventToastTimeout=null;
function showEventToast(text){
    eventToast.textContent=text;
    eventToast.classList.add("show");
    if(eventToastTimeout)clearTimeout(eventToastTimeout);
    eventToastTimeout=setTimeout(()=>eventToast.classList.remove("show"),3000);
}

/* QU√äTES */

function getQuestState(){
    const count={};
    for(let i=0;i<cellState.length;i++){
        const st=cellState[i];
        if(!st.machineId)continue;
        count[st.machineId]=(count[st.machineId]||0)+1;
    }
    return{
        resources:{...resources},
        pollutionGlobal,
        count
    };
}
function isPlayerStuck(){
    const totalProd=statProdMatter+statProdEnergy+statProdRefined;
    const lowRes=resources.matter<5 && resources.energy<3 && money<10;
    return totalProd<0.01 && lowRes;
}
function updateQuests(){
    const state=getQuestState();
    const secours=QUESTS.find(q=>q.id==="q_secours");
    if(isPlayerStuck() && secours && !secours.done){
        currentQuestIndex=QUESTS.indexOf(secours);
    }
    for(let i=currentQuestIndex;i<QUESTS.length;i++){
        const q=QUESTS[i];
        if(q.done)continue;
        if(q.condition(state)){
            q.done=true;
            currentQuestIndex=i+1;
            if(q.reward.xp)xp+=q.reward.xp;
            if(q.reward.money)money+=q.reward.money;
            if(q.reward.prestige)prestige+=q.reward.prestige;
            showEventToast("Qu√™te termin√©e : "+q.text);
        }else break;
    }
    const current=QUESTS[currentQuestIndex]||QUESTS[QUESTS.length-1];
    document.getElementById("quest-mini-text").textContent=current.text+(current.done?" (boucl√©e)":"");
    document.getElementById("top-quest-label").textContent=current.done?"Toutes les qu√™tes boucl√©es":"Qu√™te "+(currentQuestIndex+1);
    const list=document.getElementById("quest-list");
    list.innerHTML="";
    QUESTS.forEach((q,idx)=>{
        const li=document.createElement("li");
        li.textContent=(q.done?"‚úî ":"‚Ä¢ ")+q.text;
        if(idx===currentQuestIndex && !q.done)li.style.color="#c5e1a5";
        if(q.emergency && !q.done)li.style.color="#ffcc80";
        list.appendChild(li);
    });
}

/* TECH BONUSES */

function applyTechBonuses(){
    techBonuses={perMachine:{},global:{pollution:0,prod:0,extraModuleSlot:0},transport:{speed:0}};
    for(const tech of TECHS){
        if(!unlockedTechs.has(tech.id))continue;
        if(tech.bonuses){
            if(tech.bonuses.global){
                techBonuses.global.pollution+=(tech.bonuses.global.pollution||0);
                techBonuses.global.prod+=(tech.bonuses.global.prod||0);
                techBonuses.global.extraModuleSlot+=(tech.bonuses.global.extraModuleSlot||0);
            }
            if(tech.bonuses.transport){
                techBonuses.transport.speed+=(tech.bonuses.transport.speed||0);
            }
            for(const mid in tech.bonuses){
                if(mid==="global"||mid==="transport")continue;
                techBonuses.perMachine[mid]=techBonuses.perMachine[mid]||{prod:0,speed:0,pollution:0};
                const b=tech.bonuses[mid];
                techBonuses.perMachine[mid].prod+=(b.prod||0);
                techBonuses.perMachine[mid].speed+=(b.speed||0);
                techBonuses.perMachine[mid].pollution+=(b.pollution||0);
            }
        }
    }
}

/* MODULES EFFETS */

function getModuleEffects(state){
    let prod=0,pollution=0,maint=0,storage=0,fail=0;
    for(const mId of state.modules){
        if(!mId)continue;
        const mod=MODULE_TYPES[mId];
        if(!mod)continue;
        const e=mod.effects;
        prod+=(e.prod||0);
        pollution+=(e.pollution||0);
        maint+=(e.maintenance||0);
        storage+=(e.storage||0);
        fail+=(e.failure||0);
    }
    return{prod,pollution,maint,storage,fail};
}

/* SIMULATION */

function simulateTick(dt){
    gameTime+=dt;
    pollutionGlobal=0;
    let maintenanceSum=0,moduleCount=0;
    statProdMatter=0;statProdEnergy=0;statProdRefined=0;statResearch=0;

    applyTechBonuses();

    const amplificationMap=new Array(cellState.length).fill(1);

    // amplificateurs
    for(let i=0;i<cellState.length;i++){
        const st=cellState[i];
        if(!st.machineId)continue;
        const m=getMachineDef(st.machineId);
        if(!m||m.template!=="amplifier")continue;
        const mods=getModuleEffects(st);
        const baseRadius=m.special?.radius||0;
        const radius=baseRadius;
        const multiplier=(m.special?.multiplier||1)*(1+mods.prod);
        const cx=i%GRID_COLS;
        const cy=Math.floor(i/GRID_COLS);
        for(let y=-radius;y<=radius;y++){
            for(let x=-radius;x<=radius;x++){
                const nx=cx+x,ny=cy+y;
                if(nx<0||ny<0||nx>=GRID_COLS||ny>=GRID_ROWS)continue;
                const idx=ny*GRID_COLS+nx;
                amplificationMap[idx]*=multiplier;
            }
        }
    }

    // reset flux
    for(const st of cellState)st.fluxLastTick=0;

    // machines
    for(let i=0;i<cellState.length;i++){
        const st=cellState[i];
        if(!st.machineId)continue;
        const m=getMachineDef(st.machineId);
        if(!m)continue;

        const mods=getModuleEffects(st);
        const techM=techBonuses.perMachine[m.id]||{prod:0,speed:0,pollution:0};

        const maintLoss=m.maintenanceLossPerHour*(1-(mods.maint||0));
        st.maintenance-= (maintLoss/3600)*dt;
        if(st.maintenance<0)st.maintenance=0;
        if(st.maintenance<15)st.broken=true;
        if(st.maintenance>25)st.broken=false;

        let pollutionFactor=1+techM.pollution+techBonuses.global.pollution+(mods.pollution||0);
        pollutionFactor*=currentBiome.pollutionMultiplier;
        st.pollutionLocal+=m.pollution*pollutionFactor*dt;
        pollutionGlobal+=m.pollution*pollutionFactor*dt;

        if(m.template==="environmental" && m.outputs.pollution_reduction){
            pollutionGlobal-=m.outputs.pollution_reduction*dt;
        }

        if(m.template==="transport"){
            const next=getNeighborIndex(i,st.dir);
            if(next!==null){
                const speedBase=1;
                const speed=(speedBase*(1+techM.speed+techBonuses.transport.speed+mods.prod));
                for(const res in st.buffer){
                    const amount=st.buffer[res];
                    if(amount<=0)continue;
                    const moved=Math.min(amount,speed)*dt;
                    st.buffer[res]-=moved;
                    cellState[next].buffer[res]=(cellState[next].buffer[res]||0)+moved;
                    st.fluxLastTick+=moved;
                }
            }
        }

        if(m.template==="storage"){
            for(const res in m.capacity||{}){
                let cap=m.capacity[res];
                cap*=1+(mods.storage||0);
                const stored=st.buffer[res]||0;
                if(stored>cap)st.buffer[res]=cap;
            }
        }

        if(!st.broken && (m.template==="producer"||m.template==="processor"||m.template==="research")){
            let canProduce=true;
            for(const res in m.inputs){
                if((resources[res]||0)<m.inputs[res]*dt){
                    canProduce=false;break;
                }
            }
            if(canProduce){
                for(const res in m.inputs){
                    resources[res]-=m.inputs[res]*dt;
                }
                const amp=amplificationMap[i]||1;
                const levelBonus=1+0.1*(st.level-1);
                const prodBonus=1+techM.prod+techBonuses.global.prod+(mods.prod||0);
                for(const res in m.outputs){
                    let factor=1;
                    if(m.id==="panneau_solaire"){
                        factor=currentBiome.energyMultiplier;
                    }
                    const delta=m.outputs[res]*dt*amp*levelBonus*prodBonus*factor*currentBiome.prodMultiplier;
                    if(res==="matter"||res==="energy"||res==="refined"){
                        pushToStorageOrWorld(res,delta);
                    }else{
                        resources[res]=(resources[res]||0)+delta;
                    }
                    if(res==="matter")statProdMatter+=delta/dt;
                    if(res==="energy")statProdEnergy+=delta/dt;
                    if(res==="refined")statProdRefined+=delta/dt;
                    if(res==="research")statResearch+=delta/dt;
                }
                xp+=dt*((m.outputs.matter||0)+(m.outputs.energy||0)+(m.outputs.refined||0));
            }
        }

        maintenanceSum+=st.maintenance;
        moduleCount++;
    }

    maintenanceGlobal=moduleCount>0?maintenanceSum/moduleCount:100;

    const totalProd=statProdMatter+statProdEnergy+statProdRefined;
    if(totalProd<0.01)productionZeroTimer+=dt;
    else productionZeroTimer=0;

    if(productionZeroTimer>10){
        resources.matter+=0.3*dt;
        resources.energy+=0.2*dt;
        money+=0.05*dt;
    }

    const veryLowRes=resources.matter<0.1 && resources.energy<0.1 && resources.refined<0.1 && money<1;
    if(veryLowRes && gameTime-lastSurvivalBonusTime>120){
        resources.matter+=5;
        resources.energy+=3;
        money+=10;
        lastSurvivalBonusTime=gameTime;
        showEventToast("Syst√®me de secours : ressources minimales restaur√©es.");
    }

    if(xp>=xpNext){
        xp-=xpNext;
        level++;
        showLevelUpNotification(level);
        xpNext=Math.floor(xpNext*1.35+10);
    }

    updateMarketPrices();
    updateQuests();
    renderViewModes();
}

/* HUD */

function updateHUD(){
    document.getElementById("level").textContent=level;
    document.getElementById("xp").textContent=xp.toFixed(1);
    document.getElementById("xp-next").textContent=xpNext.toFixed(1);
    document.getElementById("prestige").textContent=prestige;
    const xpRatio=Math.min(1,xp/xpNext);
    document.getElementById("xp-bar").style.width=(xpRatio*100)+"%";

    document.getElementById("price-matter").textContent=market.matter.price.toFixed(1);
    document.getElementById("price-energy").textContent=market.energy.price.toFixed(1);
    document.getElementById("price-refined").textContent=market.refined.price.toFixed(1);

    document.getElementById("stat-prod-matter").textContent=statProdMatter.toFixed(2)+"/s";
    document.getElementById("stat-prod-energy").textContent=statProdEnergy.toFixed(2)+"/s";
    document.getElementById("stat-prod-refined").textContent=statProdRefined.toFixed(2)+"/s";
    document.getElementById("stat-research").textContent=statResearch.toFixed(2)+"/s";
    document.getElementById("stat-events").textContent=statEvents;

    document.getElementById("top-matter").textContent=resources.matter.toFixed(1);
    document.getElementById("top-energy").textContent=resources.energy.toFixed(1);
    document.getElementById("top-refined").textContent=resources.refined.toFixed(1);
    document.getElementById("top-waste").textContent=resources.waste.toFixed(1);
    document.getElementById("top-money").textContent=money.toFixed(0);
    document.getElementById("top-pollution").textContent=pollutionGlobal.toFixed(1);
    document.getElementById("top-maintenance").textContent=maintenanceGlobal.toFixed(0)+"%";
    document.getElementById("tech-research-points").textContent=(resources.research||0).toFixed(1);

    document.getElementById("top-biome-label").textContent="Biome: "+currentBiome.name;
    document.getElementById("biome-mini-text").textContent=currentBiome.name+" ‚Äì "+currentBiome.desc;
    document.getElementById("mode-label").textContent="Mode: "+(currentViewMode==="normal"?"Normal":currentViewMode[0].toUpperCase()+currentViewMode.slice(1));
}

/* OVERLAYS MARCH√â / STATS / AIDE / QU√äTES / INFO */

const marketOverlay=document.getElementById("market-overlay");
const marketOverlayClose=document.getElementById("market-overlay-close");
function openMarketOverlay(){refreshMarketOverlay();marketOverlay.style.display="flex";}
function closeMarketOverlay(){marketOverlay.style.display="none";}
marketOverlayClose.addEventListener("click",closeMarketOverlay);
marketOverlay.querySelector(".overlay-backdrop").addEventListener("click",closeMarketOverlay);
function refreshMarketOverlay(){
    document.getElementById("market-matter").textContent=market.matter.price.toFixed(1);
    document.getElementById("market-energy").textContent=market.energy.price.toFixed(1);
    document.getElementById("market-refined").textContent=market.refined.price.toFixed(1);
}
document.getElementById("sell-matter").addEventListener("click",()=>{sellResource("matter",10);refreshMarketOverlay();});
document.getElementById("sell-energy").addEventListener("click",()=>{sellResource("energy",10);refreshMarketOverlay();});
document.getElementById("sell-refined").addEventListener("click",()=>{sellResource("refined",5);refreshMarketOverlay();});

const statsOverlay=document.getElementById("stats-overlay");
const statsOverlayClose=document.getElementById("stats-overlay-close");
function openStatsOverlay(){statsOverlay.style.display="flex";}
function closeStatsOverlay(){statsOverlay.style.display="none";}
statsOverlayClose.addEventListener("click",closeStatsOverlay);
statsOverlay.querySelector(".overlay-backdrop").addEventListener("click",closeStatsOverlay);

const helpOverlay=document.getElementById("help-overlay");
const helpOverlayClose=document.getElementById("help-overlay-close");
function openHelpOverlay(){helpOverlay.style.display="flex";}
function closeHelpOverlay(){helpOverlay.style.display="none";}
helpOverlayClose.addEventListener("click",closeHelpOverlay);
helpOverlay.querySelector(".overlay-backdrop").addEventListener("click",closeHelpOverlay);

const questOverlay=document.getElementById("quest-overlay");
const questOverlayClose=document.getElementById("quest-overlay-close");
function openQuestOverlay(){questOverlay.style.display="flex";}
function closeQuestOverlay(){questOverlay.style.display="none";}
questOverlayClose.addEventListener("click",closeQuestOverlay);
questOverlay.querySelector(".overlay-backdrop").addEventListener("click",closeQuestOverlay);

const infoOverlay=document.getElementById("info-overlay");
const infoOverlayClose=document.getElementById("info-overlay-close");
const infoTitle=document.getElementById("info-title");
const infoBody=document.getElementById("info-body");
function openInfoOverlay(title,html){
    infoTitle.textContent=title;
    infoBody.innerHTML=html;
    infoOverlay.style.display="flex";
}
function closeInfoOverlay(){infoOverlay.style.display="none";}
infoOverlayClose.addEventListener("click",closeInfoOverlay);
infoOverlay.querySelector(".overlay-backdrop").addEventListener("click",closeInfoOverlay);

/* MENU GLOBAL */

const topMenuBtn=document.getElementById("top-menu-btn");
const mobileMenuPanel=document.getElementById("mobile-menu-panel");
let mobileMenuOpen=false;
topMenuBtn.addEventListener("click",()=>{
    mobileMenuOpen=!mobileMenuOpen;
    mobileMenuPanel.style.display=mobileMenuOpen?"block":"none";
});
document.getElementById("mmarket").addEventListener("click",openMarketOverlay);
document.getElementById("mstats").addEventListener("click",openStatsOverlay);
document.getElementById("mquests").addEventListener("click",openQuestOverlay);
document.getElementById("mhelp").addEventListener("click",openHelpOverlay);
document.getElementById("mtech").addEventListener("click",openTechOverlay);
document.getElementById("mview").addEventListener("click",cycleViewMode);
document.getElementById("mbiome").addEventListener("click",openBiomeOverlay);

/* TOP SHORTCUTS */

document.getElementById("top-resources").addEventListener("click",()=>{
    const html=`
        <div class="hud-row"><span>‚öôÔ∏è Mati√®re</span><span>${resources.matter.toFixed(1)}</span></div>
        <div class="hud-row"><span>‚ö° √ânergie</span><span>${resources.energy.toFixed(1)}</span></div>
        <div class="hud-row"><span>üíé Raffin√©e</span><span>${resources.refined.toFixed(1)}</span></div>
        <div class="hud-row"><span>üóëÔ∏è D√©chets</span><span>${resources.waste.toFixed(1)}</span></div>
    `;
    openInfoOverlay("Ressources",html);
});
document.getElementById("top-state").addEventListener("click",()=>{
    const html=`
        <div class="hud-row"><span>‚ò£Ô∏è Pollution globale</span><span>${pollutionGlobal.toFixed(1)}</span></div>
        <div class="hud-row"><span>üõ†Ô∏è Maintenance moyenne</span><span>${maintenanceGlobal.toFixed(0)}%</span></div>
        <div class="hud-row"><span>üîº Niveau</span><span>${level}</span></div>
        <div class="hud-row"><span>üèÖ Prestige</span><span>${prestige}</span></div>
    `;
    openInfoOverlay("√âtat global",html);
});
document.getElementById("top-economy").addEventListener("click",()=>{
    const html=`
        <div class="hud-row"><span>üí∞ Argent</span><span>${money.toFixed(0)}</span></div>
        <div class="hud-row"><span>Prix ‚öôÔ∏è</span><span>${market.matter.price.toFixed(1)}</span></div>
        <div class="hud-row"><span>Prix ‚ö°</span><span>${market.energy.price.toFixed(1)}</span></div>
        <div class="hud-row"><span>Prix üíé</span><span>${market.refined.price.toFixed(1)}</span></div>
    `;
    openInfoOverlay("√âconomie",html);
});
document.getElementById("top-quest").addEventListener("click",openQuestOverlay);
document.getElementById("top-tech").addEventListener("click",openTechOverlay);
document.getElementById("top-modes").addEventListener("click",cycleViewMode);
document.getElementById("top-biome").addEventListener("click",openBiomeOverlay);

/* TECH OVERLAY */

const techOverlay=document.getElementById("tech-overlay");
const techOverlayClose=document.getElementById("tech-overlay-close");
const techTreeContainer=document.getElementById("tech-tree-container");
function openTechOverlay(){renderTechTree();techOverlay.style.display="flex";}
function closeTechOverlay(){techOverlay.style.display="none";}
techOverlayClose.addEventListener("click",closeTechOverlay);
techOverlay.querySelector(".overlay-backdrop").addEventListener("click",closeTechOverlay);

function renderTechTree(){
    techTreeContainer.innerHTML="";
    const branches={};
    for(const t of TECHS){
        branches[t.branch]=branches[t.branch]||[];
        branches[t.branch].push(t);
    }
    for(const branchName in branches){
        const branch=document.createElement("div");
        branch.className="tech-branch";
        const title=document.createElement("div");
        title.className="tech-branch-title";
        title.textContent=branchName;
        branch.appendChild(title);
        branches[branchName].forEach(tech=>{
            const node=document.createElement("div");
            node.className="tech-node";
            if(!unlockedTechs.has(tech.id))node.classList.add("locked");
            const left=document.createElement("div");
            left.className="left";
            const icon=document.createElement("div");
            icon.className="icon";
            icon.textContent=tech.icon;
            const text=document.createElement("div");
            let extra="";
            if(tech.exclusiveGroup){
                extra=`<br><span style="color:#ffcc80;font-size:10px;">Choix exclusif (${tech.exclusiveGroup})</span>`;
            }
            text.innerHTML=`<strong>${tech.name}</strong><br><span style="font-size:11px;color:#b0bec5;">${tech.desc}</span>${extra}`;
            left.appendChild(icon);
            left.appendChild(text);
            const btn=document.createElement("button");
            if(unlockedTechs.has(tech.id)){
                btn.textContent="D√©bloqu√©";
                btn.disabled=true;
            }else{
                btn.textContent=`Rechercher (${tech.cost})`;
                btn.disabled=!canResearchTech(tech);
                btn.onclick=()=>researchTech(tech);
            }
            node.appendChild(left);
            node.appendChild(btn);
            branch.appendChild(node);
        });
        techTreeContainer.appendChild(branch);
    }
}
function canResearchTech(tech){
    if(resources.research<tech.cost)return false;
    for(const req of tech.requires){
        if(!unlockedTechs.has(req))return false;
    }
    if(tech.exclusiveGroup && exclusiveTechGroups[tech.exclusiveGroup] && exclusiveTechGroups[tech.exclusiveGroup]!==tech.id)return false;
    return true;
}
function researchTech(tech){
    if(!canResearchTech(tech))return;
    resources.research-=tech.cost;
    unlockedTechs.add(tech.id);
    if(tech.exclusiveGroup)exclusiveTechGroups[tech.exclusiveGroup]=tech.id;
    if(tech.unlocksMachines){
        tech.unlocksMachines.forEach(id=>{
            showEventToast("Nouvelle machine d√©bloqu√©e : "+(MACHINES[id]?.name||id));
        });
    }
    applyTechBonuses();
    renderTechTree();
}

/* UPGRADE & MODULES */

const upgradeOverlay=document.getElementById("upgrade-overlay");
const upgradeOverlayClose=document.getElementById("upgrade-overlay-close");
const upgradeBody=document.getElementById("upgrade-body");
const upgradeTitle=document.getElementById("upgrade-title");
let upgradeTargetIndex=null;

function openUpgradeOverlay(index){
    const st=cellState[index];
    if(!st || !st.machineId)return;
    upgradeTargetIndex=index;
    const m=MACHINES[st.machineId];
    upgradeTitle.textContent=`${m.icon} ${m.name}`;
    renderUpgradeOverlay();
    upgradeOverlay.style.display="flex";
}
function closeUpgradeOverlay(){upgradeOverlay.style.display="none";upgradeTargetIndex=null;}
upgradeOverlayClose.addEventListener("click",closeUpgradeOverlay);
upgradeOverlay.querySelector(".overlay-backdrop").addEventListener("click",closeUpgradeOverlay);

function getUpgradeCost(state,machine){
    const lvl=state.level||1;
    const base=10+machine.tier*10;
    return{
        money:Math.floor(base*lvl*1.4),
        energy:Math.floor(5*lvl),
        refined:lvl>=3?1:0
    };
}
function canUpgrade(state,machine){
    const cost=getUpgradeCost(state,machine);
    if(money<cost.money)return false;
    if(resources.energy<cost.energy)return false;
    if(cost.refined>0 && resources.refined<cost.refined)return false;
    return true;
}
function payUpgrade(state,machine){
    const cost=getUpgradeCost(state,machine);
    money-=cost.money;
    resources.energy-=cost.energy;
    if(cost.refined>0)resources.refined-=cost.refined;
}
function renderUpgradeOverlay(){
    const st=cellState[upgradeTargetIndex];
    const m=MACHINES[st.machineId];
    const lvl=st.level||1;
    const nextLvl=Math.min(5,lvl+1);
    const cost=getUpgradeCost(st,m);
    const canUp=lvl<5 && canUpgrade(st,m);

    upgradeBody.innerHTML="";
    const stats=document.createElement("div");
    stats.innerHTML=`
        <div class="upgrade-stat-row"><span>Niveau actuel</span><span>${lvl}</span></div>
        <div class="upgrade-stat-row"><span>Niveau apr√®s upgrade</span><span>${nextLvl}</span></div>
        <div class="upgrade-stat-row"><span>Production</span><span>+${(lvl-1)*10}% ‚Üí +${(nextLvl-1)*10}%</span></div>
        <div class="upgrade-stat-row"><span>Pollution</span><span>-${(lvl-1)*5}% ‚Üí -${(nextLvl-1)*5}%</span></div>
        <div class="upgrade-stat-row"><span>Co√ªt upgrade</span><span>${cost.money}üí∞ / ${cost.energy}‚ö° ${cost.refined>0?"/ "+cost.refined+"üíé":""}</span></div>
    `;
    upgradeBody.appendChild(stats);

    const btn=document.createElement("button");
    btn.className="overlay-close";
    btn.textContent=lvl>=5?"Niveau max atteint":"Am√©liorer";
    btn.disabled=!canUp;
    btn.onclick=()=>{
        if(!canUp)return;
        payUpgrade(st,m);
        st.level=Math.min(5,st.level+1);
        renderUpgradeOverlay();
    };
    upgradeBody.appendChild(btn);

    const modulesDiv=document.createElement("div");
    modulesDiv.className="upgrade-modules";
    const maxSlots=2+techBonuses.global.extraModuleSlot;
    modulesDiv.innerHTML=`<div style="margin-bottom:4px;">Modules (${st.modules.filter(Boolean).length}/${maxSlots})</div>`;
    for(let i=0;i<maxSlots;i++){
        const slot=document.createElement("div");
        slot.className="module-slot";
        const modId=st.modules[i];
        if(modId){
            slot.classList.add("filled");
            slot.textContent=MODULE_TYPES[modId].icon;
        }else{
            slot.textContent="+";
        }
        slot.onclick=()=>openModuleSelectOverlay(i);
        modulesDiv.appendChild(slot);
    }
    upgradeBody.appendChild(modulesDiv);
}

/* MODULE SELECT */

const moduleSelectOverlay=document.getElementById("module-select-overlay");
const moduleSelectOverlayClose=document.getElementById("module-select-overlay-close");
const moduleSelectBody=document.getElementById("module-select-body");
let moduleTargetSlot=null;

function openModuleSelectOverlay(slotIndex){
    moduleTargetSlot=slotIndex;
    renderModuleSelectOverlay();
    moduleSelectOverlay.style.display="flex";
}
function closeModuleSelectOverlay(){moduleSelectOverlay.style.display="none";moduleTargetSlot=null;}
moduleSelectOverlayClose.addEventListener("click",closeModuleSelectOverlay);
moduleSelectOverlay.querySelector(".overlay-backdrop").addEventListener("click",closeModuleSelectOverlay);

function renderModuleSelectOverlay(){
    const st=cellState[upgradeTargetIndex];
    moduleSelectBody.innerHTML="";
    for(const key in MODULE_TYPES){
        const mod=MODULE_TYPES[key];
        const btn=document.createElement("button");
        btn.className="module-btn";
        btn.innerHTML=`${mod.icon} ${mod.name} <span>${mod.desc}</span>`;
        btn.onclick=()=>{
            st.modules[moduleTargetSlot]=mod.id;
            moduleSelectOverlay.style.display="none";
            renderUpgradeOverlay();
        };
        moduleSelectBody.appendChild(btn);
    }
    const clear=document.createElement("button");
    clear.className="overlay-close";
    clear.textContent="Retirer le module";
    clear.onclick=()=>{
        st.modules[moduleTargetSlot]=null;
        moduleSelectOverlay.style.display="none";
        renderUpgradeOverlay();
    };
    moduleSelectBody.appendChild(clear);
}

/* BIOMES OVERLAY */

const biomeOverlay=document.getElementById("biome-overlay");
const biomeOverlayClose=document.getElementById("biome-overlay-close");
const biomeSelectBody=document.getElementById("biome-select-body");
function openBiomeOverlay(){
    biomeSelectBody.innerHTML="";
    for(const key in BIOMES){
        const b=BIOMES[key];
        const btn=document.createElement("button");
        btn.className="module-btn";
        btn.innerHTML=`${b.name} <span>${b.desc}</span>`;
        btn.onclick=()=>{
            currentBiome=b;
            biomeOverlay.style.display="none";
            showEventToast("Biome s√©lectionn√© : "+b.name);
        };
        biomeSelectBody.appendChild(btn);
    }
    biomeOverlay.style.display="flex";
}
function closeBiomeOverlay(){biomeOverlay.style.display="none";}
biomeOverlayClose.addEventListener("click",closeBiomeOverlay);
biomeOverlay.querySelector(".overlay-backdrop").addEventListener("click",closeBiomeOverlay);

/* TOOLTIP MACHINES */

const tooltip=document.getElementById("machine-tooltip");
function showMachineTooltip(index,event){
    const st=cellState[index];
    if(!st || !st.machineId)return;
    const m=MACHINES[st.machineId];
    if(!m)return;
    let html=`<div class="title">${m.icon} ${m.name} (Niv. ${st.level||1})</div>`;
    if(Object.keys(m.inputs).length>0){
        html+=`<div><strong>Entr√©es :</strong></div>`;
        for(const r in m.inputs){
            html+=`<div class="row"><span>${r}</span><span>${m.inputs[r]}/s</span></div>`;
        }
    }
    if(Object.keys(m.outputs).length>0){
        html+=`<div style="margin-top:4px;"><strong>Sorties :</strong></div>`;
        for(const r in m.outputs){
            html+=`<div class="row"><span>${r}</span><span>${m.outputs[r]}/s</span></div>`;
        }
    }
    html+=`<div style="margin-top:4px;" class="row"><span>Pollution</span><span>${m.pollution}</span></div>`;
    html+=`<div class="row"><span>Maintenance</span><span>${st.maintenance.toFixed(0)}%</span></div>`;
    tooltip.innerHTML=html;
    tooltip.style.display="block";
    const x=event.clientX+12;
    const y=event.clientY+12;
    tooltip.style.left=x+"px";
    tooltip.style.top=y+"px";
}
function hideMachineTooltip(){tooltip.style.display="none";}

/* MODES D‚ÄôAFFICHAGE */

function cycleViewMode(){
    const modes=["normal","flux","pollution","maintenance"];
    const idx=modes.indexOf(currentViewMode);
    currentViewMode=modes[(idx+1)%modes.length];
    renderViewModes();
}
function renderViewModes(){
    for(let i=0;i<gridCells.length;i++){
        const cell=gridCells[i];
        const st=cellState[i];
        cell.classList.remove("mode-flux-low","mode-flux-mid","mode-flux-high","mode-pollution-low","mode-pollution-mid","mode-pollution-high","mode-maint-low","mode-maint-mid","mode-maint-high");
        if(currentViewMode==="flux"){
            const f=st.fluxLastTick||0;
            if(f>0.5)cell.classList.add("mode-flux-high");
            else if(f>0.1)cell.classList.add("mode-flux-mid");
            else if(f>0.01)cell.classList.add("mode-flux-low");
        }else if(currentViewMode==="pollution"){
            const p=st.pollutionLocal||0;
            if(p>20)cell.classList.add("mode-pollution-high");
            else if(p>5)cell.classList.add("mode-pollution-mid");
            else if(p>1)cell.classList.add("mode-pollution-low");
        }else if(currentViewMode==="maintenance"){
            const m=st.maintenance||100;
            if(m<25)cell.classList.add("mode-maint-high");
            else if(m<60)cell.classList.add("mode-maint-mid");
            else cell.classList.add("mode-maint-low");
        }
    }
}

/* BOUCLE PRINCIPALE */

buildGrid();
updateQuests();
applyTechBonuses();

setInterval(()=>{
    simulateTick(TICK_MS/1000);
    updateHUD();
},TICK_MS);
</script>
</body>
</html>
