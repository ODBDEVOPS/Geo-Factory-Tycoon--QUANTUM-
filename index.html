<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Geo‚ÄëFactory Tycoon 6.0 ‚Äì Singularity MVP++</title>

<style>
*{box-sizing:border-box}
:root{
    --topbar-height:60px;
    --bottombar-height:90px;
}
body{
    margin:0;
    background:#05070a;
    color:#e5e5e5;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    overflow:hidden;
}
#game-root{
    position:relative;
    width:100vw;
    height:100vh;
    display:flex;
    background:radial-gradient(circle at top,#1b2333 0,#05070a 55%);
}
#grid-container{
    flex:1;
    position:relative;
    display:grid;
    background:#141820;
    border-left:2px solid #252b3a;
    border-right:2px solid #252b3a;
    margin-top:var(--topbar-height);
    margin-bottom:var(--bottombar-height);
}
.cell{
    border:1px solid #1f2533;
    background:#10141c;
    cursor:pointer;
    transition:background .08s,box-shadow .08s;
}
.cell:hover{
    background:#1b2230;
    box-shadow:inset 0 0 6px rgba(0,0,0,.6);
}
.module{
    position:relative;
}
.module.extracteur_quantique{
    background:linear-gradient(135deg,#2e7d32,#66bb6a);
}
.module.generateur_plasma{
    background:linear-gradient(135deg,#e64a19,#ff7043);
}
.module.convoyeur_quantique{
    background:#303f9f;
}
.module.convoyeur_quantique::before{
    content:"";
    position:absolute;
    inset:0;
    background:repeating-linear-gradient(
        90deg,
        rgba(255,255,255,.15) 0,
        rgba(255,255,255,.15) 6px,
        transparent 6px,
        transparent 12px
    );
    animation:conveyor-move .35s linear infinite;
    mix-blend-mode:screen;
}
@keyframes conveyor-move{
    from{background-position:0 0}
    to{background-position:12px 0}
}
.animated-machine{
    animation:pulse 1.2s infinite ease-in-out;
}
@keyframes pulse{
    0%{filter:brightness(1)}
    50%{filter:brightness(1.4)}
    100%{filter:brightness(1)}
}
.pipeline{
    position:absolute;
    background:#00bcd4;
    box-shadow:0 0 6px rgba(0,188,212,.8);
    z-index:3;
}

/* TOP BAR HUD PRO ‚Äì FIXED */
#top-bar{
    position:absolute;
    top:0;
    left:50%;
    transform:translateX(-50%);
    max-width:900px;
    width:90%;
    height:var(--topbar-height);
    background:rgba(5,7,12,.85);
    border-radius:999px;
    border:1px solid #283040;
    box-shadow:0 0 10px rgba(0,0,0,.6);
    padding:4px 10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    z-index:20;
}
#top-scroll{
    display:flex;
    gap:10px;
    align-items:center;
    overflow:hidden;
    white-space:nowrap;
    flex:1;
}
.top-item{
    display:inline-flex;
    align-items:center;
    gap:4px;
    font-size:12px;
    padding:2px 6px;
    border-radius:999px;
    background:#151a24;
    border:1px solid #39425a;
    cursor:pointer;
    transition:background .08s,transform .08s;
}
.top-item span.icon{
    font-size:14px;
}
.top-item:hover{
    background:#1f2634;
    transform:translateY(-1px);
}
#top-menu-btn{
    margin-left:8px;
    width:30px;
    height:30px;
    border-radius:50%;
    border:1px solid #3a4258;
    background:radial-gradient(circle at 30% 20%,#26a69a,#004d40);
    color:#fff;
    font-size:18px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    flex-shrink:0;
}

/* HUD bas : niveau / XP / prestige + mini march√© + mini qu√™tes */
#hud-bottom{
    position:absolute;
    bottom:0;
    left:50%;
    transform:translateX(-50%);
    width:70%;
    max-width:780px;
    background:rgba(5,7,12,.9);
    border-radius:12px 12px 0 0;
    padding:8px 16px 10px;
    border:1px solid #283040;
    box-shadow:0 0 12px rgba(0,0,0,.6);
    font-size:13px;
    z-index:10;
    min-height:var(--bottombar-height);
}
.hud-row{
    display:flex;
    justify-content:space-between;
    margin:2px 0;
}
#xp-bar-container{
    width:100%;
    height:10px;
    border-radius:999px;
    background:#151a24;
    overflow:hidden;
    margin-top:4px;
}
#xp-bar{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,#42a5f5,#ab47bc);
}
#market-mini{
    margin-top:4px;
    font-size:11px;
    color:#b0bec5;
}
#quest-mini{
    margin-top:4px;
    font-size:11px;
    color:#c5e1a5;
}

/* Overlays g√©n√©riques */
.overlay{
    position:absolute;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:30;
}
.overlay-backdrop{
    position:absolute;
    inset:0;
    background:rgba(0,0,0,.6);
}
.overlay-content{
    position:relative;
    min-width:260px;
    max-width:420px;
    background:#151a24;
    border-radius:12px;
    border:1px solid #3a4258;
    padding:16px 18px;
    box-shadow:0 0 18px rgba(0,0,0,.8);
    z-index:1;
    font-size:13px;
}
.overlay-content h2{
    margin:0 0 10px;
    font-size:16px;
}
.module-btn{
    width:100%;
    margin:6px 0;
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #39425a;
    background:#1f2634;
    color:#e0e0e0;
    cursor:pointer;
    text-align:left;
    font-size:13px;
}
.module-btn span{
    float:right;
    color:#90caf9;
}
.module-btn:hover{
    background:#283144;
}
.overlay-close{
    margin-top:8px;
    width:100%;
    padding:6px 0;
    border-radius:8px;
    border:1px solid #455a64;
    background:#263238;
    color:#eceff1;
    cursor:pointer;
}

/* Notification de level-up */
#level-up-notification{
    position:absolute;
    top:40%;
    left:50%;
    transform:translate(-50%,-50%) scale(0.8);
    padding:20px 30px;
    background:rgba(255,215,0,.15);
    border:2px solid rgba(255,215,0,.6);
    border-radius:12px;
    color:#ffd700;
    font-size:24px;
    font-weight:bold;
    text-shadow:0 0 10px #ffd700;
    opacity:0;
    pointer-events:none;
    transition:opacity .4s ease,transform .4s ease;
    z-index:9999;
}
#level-up-notification.show{
    opacity:1;
    transform:translate(-50%,-50%) scale(1);
}

/* Notification d‚Äô√©v√©nement / alerte */
#event-toast{
    position:absolute;
    bottom:var(--bottombar-height);
    right:16px;
    max-width:260px;
    background:rgba(33,33,33,.95);
    border-radius:10px;
    border:1px solid #455a64;
    padding:8px 10px;
    font-size:12px;
    box-shadow:0 0 10px rgba(0,0,0,.7);
    opacity:0;
    transform:translateY(10px);
    transition:opacity .25s ease,transform .25s ease;
    z-index:40;
}
#event-toast.show{
    opacity:1;
    transform:translateY(0);
}

/* Menu mobile / global (panel) */
#mobile-menu-panel{
    position:absolute;
    top:var(--topbar-height);
    right:10px;
    background:rgba(5,7,12,.95);
    border-radius:10px;
    border:1px solid #283040;
    padding:6px 8px;
    display:none;
    z-index:25;
}
.mobile-menu-btn{
    display:flex;
    align-items:center;
    gap:6px;
    padding:4px 6px;
    border-radius:6px;
    border:1px solid #39425a;
    background:#151a24;
    color:#e0e0e0;
    font-size:12px;
    cursor:pointer;
    margin:2px 0;
}
.mobile-menu-btn span.icon{
    font-size:16px;
}

/* Overlay info (d√©tails des ic√¥nes du haut) */
#info-overlay .overlay-content{
    max-width:360px;
}

/* Overlay qu√™tes */
#quest-overlay ul{
    margin:4px 0 0;
    padding-left:18px;
}

/* TOOLTIP HOLOGRAPHIQUE */
@keyframes holoShift {
    0% { background-position:0% 50%; }
    50% { background-position:100% 50%; }
    100% { background-position:0% 50%; }
}
#machine-tooltip {
    position:fixed;
    pointer-events:none;
    background:linear-gradient(135deg,rgba(0,255,255,0.18),rgba(0,150,255,0.28),rgba(0,255,200,0.18));
    background-size:200% 200%;
    animation:holoShift 4s ease-in-out infinite;
    border:1px solid rgba(0,255,255,0.7);
    padding:8px 12px;
    border-radius:10px;
    font-size:12px;
    color:#e5f9ff;
    box-shadow:0 0 12px rgba(0,255,255,0.6);
    z-index:99999;
    display:none;
    max-width:230px;
    line-height:1.35;
    backdrop-filter:blur(6px);
}
#machine-tooltip .title {
    font-weight:bold;
    margin-bottom:4px;
    color:#b3e5fc;
    text-shadow:0 0 6px rgba(0,255,255,0.7);
}
#machine-tooltip .row {
    display:flex;
    justify-content:space-between;
}
#machine-tooltip strong {
    color:#e1f5fe;
}

/* Mobile: top-bar scrollable, HUD adapt√© */
@media(max-width:768px){
    #hud-bottom{
        bottom:0;
        left:0;
        transform:none;
        width:100%;
        border-radius:10px 10px 0 0;
        padding:6px 10px 8px;
        font-size:11px;
    }
    #xp-bar-container{
        height:8px;
    }
    #market-mini,#quest-mini{
        font-size:10px;
    }
    .overlay-content{
        width:90%;
        max-width:none;
    }
    #top-bar{
        width:96%;
        padding:3px 6px;
    }
    #top-scroll{
        overflow-x:auto;
        -webkit-overflow-scrolling:touch;
    }
    .top-item{
        font-size:11px;
        padding:2px 5px;
    }
}

/* Desktop: pas de scroll visible, juste compact */
@media(min-width:769px){
    #top-scroll{
        overflow:hidden;
    }
}
</style>
</head>
<body>
<div id="game-root">

    <!-- Notification de level-up -->
    <div id="level-up-notification">Niveau +1 !</div>

    <!-- Toast d‚Äô√©v√©nements -->
    <div id="event-toast"></div>

    <!-- TOP BAR HUD PRO -->
    <div id="top-bar">
        <div id="top-scroll">
            <div class="top-item" id="top-resources">
                <span class="icon">‚öôÔ∏è</span><span id="top-matter">0.0</span>
                <span class="icon">‚ö°</span><span id="top-energy">0.0</span>
                <span class="icon">üíé</span><span id="top-refined">0.0</span>
                <span class="icon">üóëÔ∏è</span><span id="top-waste">0.0</span>
            </div>
            <div class="top-item" id="top-economy">
                <span class="icon">üí∞</span><span id="top-money">0</span>
            </div>
            <div class="top-item" id="top-state">
                <span class="icon">‚ò£Ô∏è</span><span id="top-pollution">0.0</span>
                <span class="icon">üõ†Ô∏è</span><span id="top-maintenance">100%</span>
            </div>
            <div class="top-item" id="top-quest">
                <span class="icon">üéØ</span><span id="top-quest-label">Objectif</span>
            </div>
        </div>
        <button id="top-menu-btn">‚ò∞</button>
    </div>

    <!-- HUD bas : niveau / XP / prestige + mini march√© + qu√™tes -->
    <div id="hud-bottom">
        <div class="hud-row">
            <span>üîº Niveau : <span id="level">1</span></span>
            <span>‚≠ê XP : <span id="xp">0</span> / <span id="xp-next">20</span></span>
            <span>üèÖ Prestige : <span id="prestige">0</span></span>
        </div>
        <div id="xp-bar-container">
            <div id="xp-bar"></div>
        </div>
        <div id="market-mini">
            March√© : ‚öôÔ∏è <span id="price-matter">10</span> | ‚ö° <span id="price-energy">5</span> | üíé <span id="price-refined">25</span>
        </div>
        <div id="quest-mini">
            üéØ Objectif actuel : <span id="quest-mini-text">Place un extracteur et un g√©n√©rateur.</span>
        </div>
    </div>

    <!-- Menu global (desktop + mobile) -->
    <div id="mobile-menu-panel">
        <div class="mobile-menu-btn" id="mmarket">
            <span class="icon">üíπ</span><span>March√©</span>
        </div>
        <div class="mobile-menu-btn" id="mstats">
            <span class="icon">üìä</span><span>Stats</span>
        </div>
        <div class="mobile-menu-btn" id="mquests">
            <span class="icon">üéØ</span><span>Qu√™tes</span>
        </div>
        <div class="mobile-menu-btn" id="mhelp">
            <span class="icon">‚ùî</span><span>Aide</span>
        </div>
    </div>

    <!-- Overlay s√©lection de module -->
    <div class="overlay" id="module-overlay">
        <div class="overlay-backdrop"></div>
        <div class="overlay-content">
            <h2>Placer un module</h2>
            <!-- rempli dynamiquement -->
            <button class="overlay-close" id="module-overlay-close">Annuler</button>
        </div>
    </div>

    <!-- Overlay march√© -->
    <div class="overlay" id="market-overlay">
        <div class="overlay-backdrop"></div>
        <div class="overlay-content">
            <h2>March√© Boursier</h2>
            <p>Les prix fluctuent avec le temps. Vendez vos ressources au bon moment.</p>
            <div class="hud-row"><span>‚öôÔ∏è Mati√®re</span><span id="market-matter">10</span></div>
            <div class="hud-row"><span>‚ö° √ânergie</span><span id="market-energy">5</span></div>
            <div class="hud-row"><span>üíé Raffin√©e</span><span id="market-refined">25</span></div>
            <div style="margin-top:10px;">
                <button class="module-btn" id="sell-matter">Vendre 10 ‚öôÔ∏è</button>
                <button class="module-btn" id="sell-energy">Vendre 10 ‚ö°</button>
                <button class="module-btn" id="sell-refined">Vendre 5 üíé</button>
            </div>
            <button class="overlay-close" id="market-overlay-close">Fermer</button>
        </div>
    </div>

    <!-- Overlay stats -->
    <div class="overlay" id="stats-overlay">
        <div class="overlay-backdrop"></div>
        <div class="overlay-content">
            <h2>Statistiques avanc√©es</h2>
            <p>Vue rapide de la production et de la consommation.</p>
            <div class="hud-row"><span>Prod. ‚öôÔ∏è</span><span id="stat-prod-matter">0/s</span></div>
            <div class="hud-row"><span>Prod. ‚ö°</span><span id="stat-prod-energy">0/s</span></div>
            <div class="hud-row"><span>Prod. üíé</span><span id="stat-prod-refined">0/s</span></div>
            <div class="hud-row"><span>Recherche</span><span id="stat-research">0/s</span></div>
            <div class="hud-row"><span>√âv√©nements</span><span id="stat-events">0</span></div>
            <button class="overlay-close" id="stats-overlay-close">Fermer</button>
        </div>
    </div>

    <!-- Overlay qu√™tes -->
    <div class="overlay" id="quest-overlay">
        <div class="overlay-backdrop"></div>
        <div class="overlay-content">
            <h2>Qu√™tes & Objectifs</h2>
            <p>Compl√®te des objectifs pour gagner XP, argent et prestige.</p>
            <ul id="quest-list"></ul>
            <button class="overlay-close" id="quest-overlay-close">Fermer</button>
        </div>
    </div>

    <!-- Overlay aide / tutoriel -->
    <div class="overlay" id="help-overlay">
        <div class="overlay-backdrop"></div>
        <div class="overlay-content">
            <h2>Tutoriel rapide</h2>
            <ul style="padding-left:18px;margin-top:4px;">
                <li>Clique sur une case vide pour placer un module.</li>
                <li>Les extracteurs produisent de la mati√®re, les g√©n√©rateurs de l‚Äô√©nergie.</li>
                <li>Les convoyeurs transportent les ressources entre les cases.</li>
                <li>Les silos stockent l‚Äôexc√®s, les entrep√¥ts convertissent en üí∞.</li>
                <li>Les amplificateurs boostent les machines dans un rayon.</li>
                <li>Les qu√™tes guident ta progression et d√©bloquent des bonus.</li>
            </ul>
            <button class="overlay-close" id="help-overlay-close">Fermer</button>
        </div>
    </div>

    <!-- Overlay info (d√©tails des ic√¥nes du haut) -->
    <div class="overlay" id="info-overlay">
        <div class="overlay-backdrop"></div>
        <div class="overlay-content">
            <h2 id="info-title">Infos</h2>
            <div id="info-body"></div>
            <button class="overlay-close" id="info-overlay-close">Fermer</button>
        </div>
    </div>

    <!-- Grille principale -->
    <div id="grid-container"></div>

    <!-- Tooltip holographique machines -->
    <div id="machine-tooltip"></div>
</div>

<script>
/* ============================================================
   SYST√àME DE MACHINES ‚Äî TEMPLATES + INSTANCES
   ============================================================ */

const MACHINE_TEMPLATES = {
    producer:{hasInput:false,hasOutput:true,canStore:false,isAmplifier:false,isTransport:false,isResearch:false,isEnvironmental:false,isEvent:false},
    processor:{hasInput:true,hasOutput:true,canStore:false,isAmplifier:false,isTransport:false,isResearch:false,isEnvironmental:false,isEvent:false},
    transport:{hasInput:true,hasOutput:true,canStore:false,isAmplifier:false,isTransport:true,isResearch:false,isEnvironmental:false,isEvent:false},
    storage:{hasInput:true,hasOutput:true,canStore:true,isAmplifier:false,isTransport:false,isResearch:false,isEnvironmental:false,isEvent:false},
    amplifier:{hasInput:false,hasOutput:false,canStore:false,isAmplifier:true,isTransport:false,isResearch:false,isEnvironmental:false,isEvent:false},
    research:{hasInput:false,hasOutput:true,canStore:false,isAmplifier:false,isTransport:false,isResearch:true,isEnvironmental:false,isEvent:false},
    environmental:{hasInput:false,hasOutput:false,canStore:false,isAmplifier:false,isTransport:false,isResearch:false,isEnvironmental:true,isEvent:false},
    event:{hasInput:false,hasOutput:false,canStore:false,isAmplifier:false,isTransport:false,isResearch:false,isEnvironmental:false,isEvent:true},
    special:{hasInput:false,hasOutput:false,canStore:false,isAmplifier:false,isTransport:false,isResearch:false,isEnvironmental:false,isEvent:false}
};

const MACHINES = {
    extracteur_quantique:{
        id:"extracteur_quantique",
        name:"Extracteur Quantique",
        icon:"‚õèÔ∏è",
        tier:1,
        template:"producer",
        levelReq:1,
        type:"producteur",
        cost:{energy:20,money:10},
        inputs:{},
        outputs:{matter:1.2},
        pollution:0.08,
        maintenanceLossPerHour:4,
        ports:["south","east"],
        special:{pollutionPenaltyFactor:0.0005},
        description:"Extrait la mati√®re premi√®re brute de la grille quantique."
    },
    generateur_plasma:{
        id:"generateur_plasma",
        name:"G√©n√©rateur √† Plasma",
        icon:"‚ö°",
        tier:1,
        template:"processor",
        levelReq:1,
        type:"producteur",
        cost:{matter:10,money:8},
        inputs:{matter:0.8},
        outputs:{energy:2.8},
        pollution:0.25,
        maintenanceLossPerHour:7,
        ports:["north","west"],
        special:{failureProne:true},
        description:"Convertit la mati√®re en √©nergie plasmique."
    },
    convoyeur_quantique:{
        id:"convoyeur_quantique",
        name:"Convoyeur Quantique",
        icon:"‚û°Ô∏è",
        tier:2,
        template:"transport",
        levelReq:2,
        type:"transporteur",
        cost:{energy:5,money:5},
        inputs:{},
        outputs:{},
        pollution:0.03,
        maintenanceLossPerHour:3,
        ports:["north","south","east","west"],
        special:{animated:true,speed:2},
        description:"Syst√®me de transport automatis√© avec animation."
    },
    silo_stockage:{
        id:"silo_stockage",
        name:"Silo de Stockage",
        icon:"üì¶",
        tier:2,
        template:"storage",
        levelReq:2,
        type:"stockage",
        cost:{money:20},
        inputs:{},
        outputs:{},
        pollution:0,
        maintenanceLossPerHour:2,
        capacity:{matter:200,energy:100,refined:50},
        ports:["north","south","east","west"],
        special:{priority:"overflow"},
        description:"Stocke l'exc√®s de ressources. Utilis√© en dernier recours."
    },
    entrepot_bancaire:{
        id:"entrepot_bancaire",
        name:"Entrep√¥t Bancaire",
        icon:"üí∞",
        tier:2,
        template:"storage",
        levelReq:3,
        type:"entrepot",
        cost:{energy:40,money:60},
        inputs:{matter:1},
        outputs:{money:5},
        pollution:0.02,
        maintenanceLossPerHour:3,
        capacity:{matter:100},
        ports:["north","south","east","west"],
        special:{priority:"money"},
        description:"Convertit la mati√®re stock√©e en argent liquide."
    },
    panneau_solaire:{
        id:"panneau_solaire",
        name:"Panneau Solaire",
        icon:"‚òÄÔ∏è",
        tier:2,
        template:"producer",
        levelReq:2,
        type:"producteur",
        cost:{money:25},
        inputs:{},
        outputs:{energy:1.4},
        pollution:0,
        maintenanceLossPerHour:2,
        ports:[],
        special:{efficiencyRange:[0.5,1.5],affectedByDayNight:true},
        description:"G√©n√®re de l'√©nergie solaire propre."
    },
    raffinerie_avancee:{
        id:"raffinerie_avancee",
        name:"Raffinerie Avanc√©e",
        icon:"üè≠",
        tier:3,
        template:"processor",
        levelReq:4,
        type:"processeur",
        cost:{energy:30,money:40},
        inputs:{matter:3,energy:0.8},
        outputs:{refined:2},
        pollution:0.7,
        maintenanceLossPerHour:9,
        quality:3,
        ports:["north","south"],
        special:{premiumOutput:true},
        description:"Raffine la mati√®re brute en ressource premium."
    },
    laboratoire_recherche:{
        id:"laboratoire_recherche",
        name:"Laboratoire de Recherche",
        icon:"üî¨",
        tier:3,
        template:"research",
        levelReq:4,
        type:"recherche",
        cost:{energy:40,money:60},
        inputs:{energy:1},
        outputs:{research:0.4},
        pollution:0.15,
        maintenanceLossPerHour:8,
        ports:["east","west"],
        special:{branchSpecialization:true},
        description:"G√©n√®re des points de recherche technologique."
    },
    purificateur_ecologique:{
        id:"purificateur_ecologique",
        name:"Purificateur √âcologique",
        icon:"üå±",
        tier:3,
        template:"environmental",
        levelReq:4,
        type:"environnemental",
        cost:{energy:20,money:50},
        inputs:{},
        outputs:{pollution_reduction:1.5},
        pollution:-0.8,
        maintenanceLossPerHour:5,
        ports:[],
        special:{reputationBonus:true,penaltyReduction:true},
        description:"R√©duit la pollution globale de l'usine."
    },
    ordinateur_quantique:{
        id:"ordinateur_quantique",
        name:"Ordinateur Quantique",
        icon:"üíª",
        tier:4,
        template:"amplifier",
        levelReq:5,
        type:"amplificateur",
        cost:{energy:80,money:120},
        inputs:{},
        outputs:{},
        pollution:0.05,
        maintenanceLossPerHour:10,
        ports:[],
        special:{radius:2,multiplier:1.6},
        description:"Boost la production des machines adjacentes."
    },
    centre_evenementiel:{
        id:"centre_evenementiel",
        name:"Centre √âv√©nementiel",
        icon:"‚è±Ô∏è",
        tier:3,
        template:"event",
        levelReq:3,
        type:"evenement",
        cost:{money:50},
        inputs:{},
        outputs:{},
        pollution:0,
        maintenanceLossPerHour:3,
        ports:[],
        special:{eventCooldown:45},
        description:"D√©clenche des √©v√©nements al√©atoires : bonus, pannes, m√©t√©o extr√™me."
    }
};

const MACHINE_GROUPS = {
    tier1:["extracteur_quantique","generateur_plasma"],
    tier2:["convoyeur_quantique","silo_stockage","entrepot_bancaire","panneau_solaire"],
    tier3:["raffinerie_avancee","laboratoire_recherche","purificateur_ecologique","centre_evenementiel"],
    tier4:["ordinateur_quantique"]
};

function getMachineDef(id){return MACHINES[id];}

/* ============================================================
   √âTAT GLOBAL & MOTEUR
   ============================================================ */

let level=1,prestige=0;
let gridCols=8,gridRows=6;
let gridCells=[],cellState=[];
const resources={matter:0,energy:0,refined:0,waste:0,bricks:0,rare_bricks:0,research:0};
let money=50;
let pollutionGlobal=0,maintenanceGlobal=100;
let xp=0,xpNext=20;
const market={
    matter:{price:10,volatility:0.2},
    energy:{price:5,volatility:0.15},
    refined:{price:25,volatility:0.25}
};
const CHUNK_SIZE=6;
let spatialGrid={};
let lastTime=0,marketTimer=0;
let isDay=true,dayTimer=0,weather="clear";

/* stats instantan√©es simples */
let statProdMatter=0,statProdEnergy=0,statProdRefined=0,statResearch=0;
let statEvents=0;

/* anti soft-lock */
let productionZeroTimer=0;
let gameTime=0;
let lastSurvivalBonusTime=-999;

/* qu√™tes / objectifs */
const QUESTS=[
    {
        id:"q1",
        text:"Place un extracteur et un g√©n√©rateur.",
        condition:state=>state.count.extracteur_quantique>=1 && state.count.generateur_plasma>=1,
        reward:{xp:15,money:30},
        done:false
    },
    {
        id:"q2",
        text:"Atteins 50 ‚öôÔ∏è et 30 ‚ö°.",
        condition:state=>state.resources.matter>=50 && state.resources.energy>=30,
        reward:{xp:25,money:40},
        done:false
    },
    {
        id:"q3",
        text:"Construis un silo et une raffinerie.",
        condition:state=>state.count.silo_stockage>=1 && state.count.raffinerie_avancee>=1,
        reward:{xp:40,money:60},
        done:false
    },
    {
        id:"q4",
        text:"R√©duis la pollution globale sous 5.",
        condition:state=>state.pollutionGlobal<5,
        reward:{xp:50,money:80,prestige:1},
        done:false
    },
    {
        id:"q_secours",
        text:"Reconstruis un extracteur pour relancer la production.",
        condition:state=>state.count.extracteur_quantique>=1,
        reward:{xp:20,money:20},
        done:false,
        emergency:true
    }
];
let currentQuestIndex=0;

const gridContainer=document.getElementById("grid-container");

function createEmptyCellState(){
    return{
        machineId:null,
        maintenance:100,
        pollutionLocal:0,
        broken:false,
        buffer:{},
        eventTimer:0
    };
}

function getChunkCoords(index){
    const row=Math.floor(index/gridCols);
    const col=index%gridCols;
    return{cx:Math.floor(col/CHUNK_SIZE),cy:Math.floor(row/CHUNK_SIZE)};
}

function buildGrid(){
    gridContainer.innerHTML="";
    gridContainer.style.gridTemplateColumns=`repeat(${gridCols},1fr)`;
    gridContainer.style.gridTemplateRows=`repeat(${gridRows},1fr)`;
    gridCells=[];
    cellState=[];
    spatialGrid={};
    const total=gridCols*gridRows;
    for(let i=0;i<total;i++){
        const cell=document.createElement("div");
        cell.classList.add("cell");
        cell.dataset.index=i;
        cellState[i]=createEmptyCellState();

        cell.addEventListener("click",()=>{selectedCellIndex=i;openModuleOverlay();});

        // Tooltips desktop
        cell.addEventListener("mousemove",(e)=>{
            if(cellState[i].machineId) showMachineTooltip(i,e);
        });
        cell.addEventListener("mouseleave",()=>{
            hideMachineTooltip();
        });

        // Tooltips mobile (long press)
        let pressTimer;
        cell.addEventListener("touchstart",(e)=>{
            pressTimer=setTimeout(()=>{
                if(cellState[i].machineId) showMachineTooltip(i,e.touches[0]);
            },350);
        });
        cell.addEventListener("touchend",()=>{
            clearTimeout(pressTimer);
            hideMachineTooltip();
        });

        gridContainer.appendChild(cell);
        gridCells.push(cell);
        const {cx,cy}=getChunkCoords(i);
        const key=`${cx},${cy}`;
        if(!spatialGrid[key])spatialGrid[key]=[];
        spatialGrid[key].push(i);
    }
    updatePipelines();
}

function getNeighbors(i){
    const row=Math.floor(i/gridCols);
    const col=i%gridCols;
    const res=[];
    res.push(col>0?i-1:null);
    res.push(col<gridCols-1?i+1:null);
    res.push(row>0?i-gridCols:null);
    res.push(row<gridRows-1?i+gridCols:null);
    return res;
}

function drawPipelineBetween(aIndex,bIndex){
    const a=gridCells[aIndex],b=gridCells[bIndex];
    if(!a||!b)return;
    const rectA=a.getBoundingClientRect();
    const rectB=b.getBoundingClientRect();
    const pipe=document.createElement("div");
    pipe.classList.add("pipeline");
    if(rectA.top===rectB.top){
        pipe.style.top=(rectA.top+rectA.height/2)+"px";
        pipe.style.height="4px";
        pipe.style.left=Math.min(rectA.left,rectB.left)+rectA.width+"px";
        pipe.style.width=Math.abs(rectA.left-rectB.left)-rectA.width+"px";
    }
    if(rectA.left===rectB.left){
        pipe.style.left=(rectA.left+rectA.width/2)+"px";
        pipe.style.width="4px";
        pipe.style.top=Math.min(rectA.top,rectB.top)+rectA.height+"px";
        pipe.style.height=Math.abs(rectA.top-rectB.top)-rectA.height+"px";
    }
    document.body.appendChild(pipe);
}

function updatePipelines(){
    document.querySelectorAll(".pipeline").forEach(p=>p.remove());
    const total=gridCols*gridRows;
    for(let i=0;i<total;i++){
        const state=cellState[i];
        if(!state.machineId)continue;
        const neighbors=getNeighbors(i);
        neighbors.forEach(nIndex=>{
            if(nIndex===null)return;
            const nState=cellState[nIndex];
            if(!nState.machineId)return;
            drawPipelineBetween(i,nIndex);
        });
    }
}

/* ============================================================
   OVERLAY MODULES
   ============================================================ */

const moduleOverlay=document.getElementById("module-overlay");
const moduleOverlayClose=document.getElementById("module-overlay-close");
let selectedCellIndex=null;

function openModuleOverlay(){populateModuleOverlay();moduleOverlay.style.display="flex";}
function closeModuleOverlay(){moduleOverlay.style.display="none";selectedCellIndex=null;}
moduleOverlayClose.addEventListener("click",closeModuleOverlay);
moduleOverlay.querySelector(".overlay-backdrop").addEventListener("click",closeModuleOverlay);

function canAfford(machine){
    if(!machine.cost)return true;
    if(machine.cost.money && money<machine.cost.money)return false;
    for(const r in machine.cost){
        if(r==="money")continue;
        if((resources[r]||0)<machine.cost[r])return false;
    }
    return true;
}
function payCost(machine){
    if(!machine.cost)return;
    if(machine.cost.money)money-=machine.cost.money;
    for(const r in machine.cost){
        if(r==="money")continue;
        resources[r]-=machine.cost[r];
    }
}

function placeModule(index,id){
    const state=cellState[index];
    if(state.machineId)return;
    const machine=getMachineDef(id);
    if(!canAfford(machine))return;
    payCost(machine);
    state.machineId=id;
    state.maintenance=100;
    state.pollutionLocal=0;
    state.broken=false;
    state.buffer={};
    state.eventTimer=0;
    const cell=gridCells[index];
    cell.classList.add("module",id);
    if(machine&&machine.special&&machine.special.animated)cell.classList.add("animated-machine");
    updatePipelines();
}

function populateModuleOverlay(){
    const container=document.querySelector("#module-overlay .overlay-content");
    container.innerHTML="<h2>Placer un module</h2>";
    for(const groupName in MACHINE_GROUPS){
        const title=document.createElement("div");
        title.textContent=groupName.toUpperCase();
        title.style.marginTop="10px";
        title.style.fontWeight="bold";
        container.appendChild(title);
        MACHINE_GROUPS[groupName].forEach(id=>{
            const m=MACHINES[id];
            if(!m)return;
            const btn=document.createElement("button");
            btn.className="module-btn";
            btn.dataset.module=id;
            const affordable=canAfford(m);
            btn.style.opacity=affordable?1:0.4;
            btn.innerHTML=`${m.icon} ${m.name} <span>T${m.tier}</span>`;
            btn.onclick=()=>{if(affordable){placeModule(selectedCellIndex,id);closeModuleOverlay();}};
            container.appendChild(btn);
        });
    }
    const close=document.createElement("button");
    close.className="overlay-close";
    close.textContent="Annuler";
    close.onclick=closeModuleOverlay;
    container.appendChild(close);
}

/* ============================================================
   ENVIRONNEMENT (JOUR/NUIT + M√âT√âO)
   ============================================================ */

function randomWeather(){
    const list=["clear","cloudy","storm","rain"];
    return list[Math.floor(Math.random()*list.length)];
}
function updateEnvironment(dt){
    dayTimer+=dt;
    if(dayTimer>=60){
        isDay=!isDay;
        dayTimer=0;
    }
    if(Math.random()<dt*0.01){
        weather=randomWeather();
        showEventToast("Changement m√©t√©o : "+weather.toUpperCase());
    }
}

/* ============================================================
   MARCH√â & √âCONOMIE
   ============================================================ */

function updateMarketPrices(){
    for(const key in market){
        const asset=market[key];
        const delta=(Math.random()-0.5)*asset.volatility*asset.price;
        asset.price=Math.max(1,asset.price+delta);
    }
}
function sellResource(type,amount){
    if(resources[type]<amount)return;
    resources[type]-=amount;
    money+=market[type].price*amount;
}

/* ============================================================
   TRANSPORT & STOCKAGE (priorit√©s + overflow)
   ============================================================ */

function getNextCell(index,machine){
    const neighbors=getNeighbors(index);
    for(const n of neighbors){
        if(n===null)continue;
        const st=cellState[n];
        if(!st.machineId)continue;
        const m=getMachineDef(st.machineId);
        if(!m)continue;
        if(m.template==="storage"||m.template==="processor"||m.template==="producer")return n;
    }
    return null;
}

function pushToStorageOrWorld(resName,amount){
    let remaining=amount;

    // entrep√¥ts (money)
    for(let i=0;i<cellState.length;i++){
        const st=cellState[i];
        if(!st.machineId)continue;
        const m=getMachineDef(st.machineId);
        if(!m||m.template!=="storage")continue;
        if(m.special?.priority!=="money")continue;
        const cap=m.capacity?.[resName];
        if(!cap)continue;
        const stored=st.buffer[resName]||0;
        const free=cap-stored;
        if(free<=0)continue;
        const move=Math.min(free,remaining);
        st.buffer[resName]=(st.buffer[resName]||0)+move;
        remaining-=move;
        if(remaining<=0)return;
    }

    // silos overflow
    for(let i=0;i<cellState.length;i++){
        const st=cellState[i];
        if(!st.machineId)continue;
        const m=getMachineDef(st.machineId);
        if(!m||m.template!=="storage")continue;
        if(m.special?.priority!=="overflow")continue;
        const cap=m.capacity?.[resName];
        if(!cap)continue;
        const stored=st.buffer[resName]||0;
        const free=cap-stored;
        if(free<=0)continue;
        const move=Math.min(free,remaining);
        st.buffer[resName]=(st.buffer[resName]||0)+move;
        remaining-=move;
        if(remaining<=0)return;
    }

    if(remaining>0){
        resources.waste+=remaining;
    }
}

/* ============================================================
   NOTIFICATIONS
   ============================================================ */

function showLevelUpNotification(newLevel){
    const notif=document.getElementById("level-up-notification");
    notif.textContent="Niveau "+newLevel+" atteint !";
    notif.classList.add("show");
    setTimeout(()=>{notif.classList.remove("show");},2000);
}

const eventToast=document.getElementById("event-toast");
let eventToastTimeout=null;
function showEventToast(text){
    eventToast.textContent=text;
    eventToast.classList.add("show");
    if(eventToastTimeout)clearTimeout(eventToastTimeout);
    eventToastTimeout=setTimeout(()=>{
        eventToast.classList.remove("show");
    },3000);
}

/* ============================================================
   QU√äTES / OBJECTIFS
   ============================================================ */

function getQuestState(){
    const count={};
    for(let i=0;i<cellState.length;i++){
        const st=cellState[i];
        if(!st.machineId)continue;
        count[st.machineId]=(count[st.machineId]||0)+1;
    }
    return{
        resources:{...resources},
        pollutionGlobal,
        count
    };
}

function isPlayerStuck(){
    const totalProd=statProdMatter+statProdEnergy+statProdRefined;
    const lowRes=resources.matter<5 && resources.energy<3 && money<10;
    return totalProd<0.01 && lowRes;
}

function updateQuests(){
    const state=getQuestState();

    // activer la qu√™te de secours si bloqu√©
    const secours=QUESTS.find(q=>q.id==="q_secours");
    if(isPlayerStuck() && secours && !secours.done){
        currentQuestIndex=QUESTS.indexOf(secours);
    }

    for(let i=currentQuestIndex;i<QUESTS.length;i++){
        const q=QUESTS[i];
        if(q.done)continue;
        if(q.condition(state)){
            q.done=true;
            currentQuestIndex=i+1;
            if(q.reward.xp)xp+=q.reward.xp;
            if(q.reward.money)money+=q.reward.money;
            if(q.reward.prestige)prestige+=q.reward.prestige;
            showEventToast("Qu√™te termin√©e : "+q.text);
        }else{
            break;
        }
    }
    const current=QUESTS[currentQuestIndex]||QUESTS[QUESTS.length-1];
    document.getElementById("quest-mini-text").textContent=current.text+(current.done?" (boucl√©e)":"");
    document.getElementById("top-quest-label").textContent=current.done?"Toutes les qu√™tes boucl√©es":"Qu√™te "+(currentQuestIndex+1);
    const list=document.getElementById("quest-list");
    list.innerHTML="";
    QUESTS.forEach((q,idx)=>{
        const li=document.createElement("li");
        li.textContent=(q.done?"‚úî ":"‚Ä¢ ")+q.text;
        if(idx===currentQuestIndex && !q.done)li.style.color="#c5e1a5";
        if(q.emergency && !q.done)li.style.color="#ffcc80";
        list.appendChild(li);
    });
}

/* ============================================================
   SIMULATION
   ============================================================ */

let lastEventTime=0;

function gameLoop(timestamp){
    const dt=(timestamp-lastTime)/1000||0;
    lastTime=timestamp;
    simulate(dt);
    updateHUD();
    requestAnimationFrame(gameLoop);
}

function simulate(dt){
    gameTime+=dt;
    updateEnvironment(dt);
    pollutionGlobal=0;
    let maintenanceSum=0,moduleCount=0;
    const amplificationMap=new Array(cellState.length).fill(1);
    statProdMatter=0;statProdEnergy=0;statProdRefined=0;statResearch=0;

    // amplificateurs
    for(let i=0;i<cellState.length;i++){
        const state=cellState[i];
        if(!state.machineId)continue;
        const machine=getMachineDef(state.machineId);
        if(!machine)continue;
        if(machine.template==="amplifier"){
            const radius=machine.special?.radius||0;
            const multiplier=machine.special?.multiplier||1;
            const cx=i%gridCols;
            const cy=Math.floor(i/gridCols);
            for(let y=-radius;y<=radius;y++){
                for(let x=-radius;x<=radius;x++){
                    const nx=cx+x,ny=cy+y;
                    if(nx<0||ny<0||nx>=gridCols||ny>=gridRows)continue;
                    const idx=ny*gridCols+nx;
                    amplificationMap[idx]*=multiplier;
                }
            }
        }
    }

    for(const key in spatialGrid){
        const indices=spatialGrid[key];
        for(const index of indices){
            const state=cellState[index];
            if(!state.machineId)continue;
            const machine=getMachineDef(state.machineId);
            if(!machine)continue;

            state.maintenance-= (machine.maintenanceLossPerHour/3600)*dt;
            if(state.maintenance<0)state.maintenance=0;
            if(state.maintenance<15)state.broken=true;
            if(state.maintenance>25)state.broken=false;

            state.pollutionLocal+=machine.pollution*dt;
            pollutionGlobal+=machine.pollution*dt;

            if(machine.template==="environmental" && machine.outputs.pollution_reduction){
                pollutionGlobal-=machine.outputs.pollution_reduction*dt;
            }

            if(machine.template==="transport"){
                const next=getNextCell(index,machine);
                if(next!==null){
                    for(const res in state.buffer){
                        const amount=state.buffer[res];
                        if(amount<=0)continue;
                        const moved=Math.min(amount,machine.special?.speed||1)*dt;
                        state.buffer[res]-=moved;
                        cellState[next].buffer[res]=(cellState[next].buffer[res]||0)+moved;
                    }
                }
            }

            if(machine.template==="storage"){
                for(const res in machine.capacity||{}){
                    const cap=machine.capacity[res];
                    const stored=state.buffer[res]||0;
                    if(stored>cap)state.buffer[res]=cap;
                }
            }

            if(machine.template==="event"){
                state.eventTimer+=dt;
                const cd=machine.special?.eventCooldown||45;
                if(state.eventTimer>=cd){
                    state.eventTimer=0;
                    triggerRandomEvent(index);
                }
            }

            if(!state.broken && (machine.template==="producer"||machine.template==="processor"||machine.template==="research")){
                let canProduce=true;
                for(const res in machine.inputs){
                    if((resources[res]||0)<machine.inputs[res]*dt){
                        canProduce=false;break;
                    }
                }
                if(canProduce){
                    for(const res in machine.inputs){
                        resources[res]-=machine.inputs[res]*dt;
                    }
                    let pollutionMultiplier=1;
                    if(machine.special&&machine.special.pollutionPenaltyFactor){
                        const penalty=pollutionGlobal*machine.special.pollutionPenaltyFactor;
                        pollutionMultiplier=Math.max(0.5,1-penalty);
                    }
                    const amp=amplificationMap[index]||1;
                    for(const res in machine.outputs){
                        let factor=1;
                        if(machine.id==="panneau_solaire"){
                            factor=isDay?1:0.25;
                            if(weather==="cloudy")factor*=0.7;
                            if(weather==="storm")factor*=0.4;
                        }
                        const delta=machine.outputs[res]*dt*pollutionMultiplier*amp*factor;
                        if(res==="matter"||res==="energy"||res==="refined"){
                            pushToStorageOrWorld(res,delta);
                        }else{
                            resources[res]=(resources[res]||0)+delta;
                        }
                        if(res==="matter")statProdMatter+=delta/dt;
                        if(res==="energy")statProdEnergy+=delta/dt;
                        if(res==="refined")statProdRefined+=delta/dt;
                        if(res==="research")statResearch+=delta/dt;
                    }
                    xp+=dt*((machine.outputs.matter||0)+(machine.outputs.energy||0)+(machine.outputs.refined||0));
                }
            }

            maintenanceSum+=state.maintenance;
            moduleCount++;
        }
    }

    maintenanceGlobal=moduleCount>0?maintenanceSum/moduleCount:100;

    // conversion automatique des entrep√¥ts bancaires
    for(let i=0;i<cellState.length;i++){
        const st=cellState[i];
        if(!st.machineId)continue;
        const m=getMachineDef(st.machineId);
        if(!m||m.id!=="entrepot_bancaire")continue;
        const stored=st.buffer.matter||0;
        if(stored>0){
            const convert=Math.min(stored,1*dt);
            st.buffer.matter-=convert;
            money+=convert*market.matter.price*0.6;
        }
    }

    // anti soft-lock : g√©n√©rateur d'urgence
    const totalProd=statProdMatter+statProdEnergy+statProdRefined;
    if(totalProd<0.01){
        productionZeroTimer+=dt;
    }else{
        productionZeroTimer=0;
    }
    if(productionZeroTimer>10){
        resources.matter+=0.3*dt;
        resources.energy+=0.2*dt;
        money+=0.05*dt;
    }

    // bonus de survie
    const veryLowRes=resources.matter<0.1 && resources.energy<0.1 && resources.refined<0.1 && money<1;
    if(veryLowRes && gameTime-lastSurvivalBonusTime>120){
        resources.matter+=5;
        resources.energy+=3;
        money+=10;
        lastSurvivalBonusTime=gameTime;
        showEventToast("Syst√®me de secours : ressources minimales restaur√©es.");
    }

    // level up
    if(xp>=xpNext){
        xp-=xpNext;
        level++;
        showLevelUpNotification(level);
        xpNext=Math.floor(xpNext*1.35+10);
        // progression : agrandir la grille de fa√ßon dynamique
        gridCols++;
        if(level%2===0)gridRows++;
        buildGrid();
    }

    // march√©
    marketTimer+=dt;
    if(marketTimer>=5){
        marketTimer=0;
        updateMarketPrices();
    }

    // qu√™tes
    updateQuests();
}

/* ============================================================
   √âV√âNEMENTS AL√âATOIRES (centre √©v√©nementiel)
   ============================================================ */

function triggerRandomEvent(index){
    const roll=Math.random();
    statEvents++;
    if(roll<0.33){
        xp+=10;
        money+=20;
        showEventToast("√âv√©nement : boost de production global (+XP, +üí∞) !");
    }else if(roll<0.66){
        const st=cellState[index];
        st.maintenance=Math.max(5,st.maintenance-40);
        st.broken=true;
        showEventToast("√âv√©nement : panne locale, maintenance r√©duite !");
    }else{
        weather="storm";
        showEventToast("√âv√©nement : temp√™te √©nerg√©tique, panneaux solaires affaiblis !");
    }
}

/* ============================================================
   HUD & UI
   ============================================================ */

function updateHUD(){
    document.getElementById("level").textContent=level;
    document.getElementById("xp").textContent=xp.toFixed(1);
    document.getElementById("xp-next").textContent=xpNext.toFixed(1);
    document.getElementById("prestige").textContent=prestige;
    const xpRatio=Math.min(1,xp/xpNext);
    document.getElementById("xp-bar").style.width=(xpRatio*100)+"%";
    document.getElementById("price-matter").textContent=market.matter.price.toFixed(1);
    document.getElementById("price-energy").textContent=market.energy.price.toFixed(1);
    document.getElementById("price-refined").textContent=market.refined.price.toFixed(1);

    document.getElementById("stat-prod-matter").textContent=statProdMatter.toFixed(2)+"/s";
    document.getElementById("stat-prod-energy").textContent=statProdEnergy.toFixed(2)+"/s";
    document.getElementById("stat-prod-refined").textContent=statProdRefined.toFixed(2)+"/s";
    document.getElementById("stat-research").textContent=statResearch.toFixed(2)+"/s";
    document.getElementById("stat-events").textContent=statEvents;

    document.getElementById("top-matter").textContent=resources.matter.toFixed(1);
    document.getElementById("top-energy").textContent=resources.energy.toFixed(1);
    document.getElementById("top-refined").textContent=resources.refined.toFixed(1);
    document.getElementById("top-waste").textContent=resources.waste.toFixed(1);
    document.getElementById("top-money").textContent=money.toFixed(0);
    document.getElementById("top-pollution").textContent=pollutionGlobal.toFixed(1);
    document.getElementById("top-maintenance").textContent=maintenanceGlobal.toFixed(0)+"%";
}

/* ============================================================
   OVERLAYS MARCH√â / STATS / AIDE / QU√äTES
   ============================================================ */

const marketOverlay=document.getElementById("market-overlay");
const marketOverlayClose=document.getElementById("market-overlay-close");
function openMarketOverlay(){marketOverlay.style.display="flex";refreshMarketOverlay();}
function closeMarketOverlay(){marketOverlay.style.display="none";}
marketOverlayClose.addEventListener("click",closeMarketOverlay);
marketOverlay.querySelector(".overlay-backdrop").addEventListener("click",closeMarketOverlay);
function refreshMarketOverlay(){
    document.getElementById("market-matter").textContent=market.matter.price.toFixed(1);
    document.getElementById("market-energy").textContent=market.energy.price.toFixed(1);
    document.getElementById("market-refined").textContent=market.refined.price.toFixed(1);
}
document.getElementById("sell-matter").addEventListener("click",()=>{sellResource("matter",10);refreshMarketOverlay();});
document.getElementById("sell-energy").addEventListener("click",()=>{sellResource("energy",10);refreshMarketOverlay();});
document.getElementById("sell-refined").addEventListener("click",()=>{sellResource("refined",5);refreshMarketOverlay();});

const statsOverlay=document.getElementById("stats-overlay");
const statsOverlayClose=document.getElementById("stats-overlay-close");
function openStatsOverlay(){statsOverlay.style.display="flex";}
function closeStatsOverlay(){statsOverlay.style.display="none";}
statsOverlayClose.addEventListener("click",closeStatsOverlay);
statsOverlay.querySelector(".overlay-backdrop").addEventListener("click",closeStatsOverlay);

const helpOverlay=document.getElementById("help-overlay");
const helpOverlayClose=document.getElementById("help-overlay-close");
function openHelpOverlay(){helpOverlay.style.display="flex";}
function closeHelpOverlay(){helpOverlay.style.display="none";}
helpOverlayClose.addEventListener("click",closeHelpOverlay);
helpOverlay.querySelector(".overlay-backdrop").addEventListener("click",closeHelpOverlay);

const questOverlay=document.getElementById("quest-overlay");
const questOverlayClose=document.getElementById("quest-overlay-close");
function openQuestOverlay(){questOverlay.style.display="flex";}
function closeQuestOverlay(){questOverlay.style.display="none";}
questOverlayClose.addEventListener("click",closeQuestOverlay);
questOverlay.querySelector(".overlay-backdrop").addEventListener("click",closeQuestOverlay);

/* ============================================================
   MENU GLOBAL (TOP BTN + MOBILE)
   ============================================================ */

const topMenuBtn=document.getElementById("top-menu-btn");
const mobileMenuPanel=document.getElementById("mobile-menu-panel");
let mobileMenuOpen=false;
topMenuBtn.addEventListener("click",()=>{
    mobileMenuOpen=!mobileMenuOpen;
    mobileMenuPanel.style.display=mobileMenuOpen?"block":"none";
});
document.getElementById("mmarket").addEventListener("click",()=>{openMarketOverlay();});
document.getElementById("mstats").addEventListener("click",()=>{openStatsOverlay();});
document.getElementById("mquests").addEventListener("click",()=>{openQuestOverlay();});
document.getElementById("mhelp").addEventListener("click",()=>{openHelpOverlay();});

/* ============================================================
   OVERLAY INFO (ic√¥nes du haut)
   ============================================================ */

const infoOverlay=document.getElementById("info-overlay");
const infoOverlayClose=document.getElementById("info-overlay-close");
const infoTitle=document.getElementById("info-title");
const infoBody=document.getElementById("info-body");

function openInfoOverlay(title,html){
    infoTitle.textContent=title;
    infoBody.innerHTML=html;
    infoOverlay.style.display="flex";
}
function closeInfoOverlay(){infoOverlay.style.display="none";}
infoOverlayClose.addEventListener("click",closeInfoOverlay);
infoOverlay.querySelector(".overlay-backdrop").addEventListener("click",closeInfoOverlay);

document.getElementById("top-resources").addEventListener("click",()=>{
    const html=`
        <div class="hud-row"><span>‚öôÔ∏è Mati√®re</span><span>${resources.matter.toFixed(1)}</span></div>
        <div class="hud-row"><span>‚ö° √ânergie</span><span>${resources.energy.toFixed(1)}</span></div>
        <div class="hud-row"><span>üíé Raffin√©e</span><span>${resources.refined.toFixed(1)}</span></div>
        <div class="hud-row"><span>üóëÔ∏è D√©chets</span><span>${resources.waste.toFixed(1)}</span></div>
    `;
    openInfoOverlay("Ressources",html);
});
document.getElementById("top-state").addEventListener("click",()=>{
    const html=`
        <div class="hud-row"><span>‚ò£Ô∏è Pollution globale</span><span>${pollutionGlobal.toFixed(1)}</span></div>
        <div class="hud-row"><span>üõ†Ô∏è Maintenance moyenne</span><span>${maintenanceGlobal.toFixed(0)}%</span></div>
        <div class="hud-row"><span>üîº Niveau</span><span>${level}</span></div>
        <div class="hud-row"><span>üèÖ Prestige</span><span>${prestige}</span></div>
    `;
    openInfoOverlay("√âtat global",html);
});
document.getElementById("top-economy").addEventListener("click",()=>{
    const html=`
        <div class="hud-row"><span>üí∞ Argent</span><span>${money.toFixed(0)}</span></div>
        <div class="hud-row"><span>Prix ‚öôÔ∏è</span><span>${market.matter.price.toFixed(1)}</span></div>
        <div class="hud-row"><span>Prix ‚ö°</span><span>${market.energy.price.toFixed(1)}</span></div>
        <div class="hud-row"><span>Prix üíé</span><span>${market.refined.price.toFixed(1)}</span></div>
    `;
    openInfoOverlay("√âconomie",html);
});
document.getElementById("top-quest").addEventListener("click",()=>{
    openQuestOverlay();
});

/* ============================================================
   TOOLTIP MACHINES (HOLOGRAPHIQUE)
   ============================================================ */

const tooltip=document.getElementById("machine-tooltip");

function showMachineTooltip(index,event){
    const state=cellState[index];
    if(!state || !state.machineId)return;
    const m=MACHINES[state.machineId];
    if(!m)return;

    let html=`<div class="title">${m.icon} ${m.name}</div>`;

    if(Object.keys(m.inputs).length>0){
        html+=`<div><strong>Entr√©es :</strong></div>`;
        for(const r in m.inputs){
            html+=`<div class="row"><span>${r}</span><span>${m.inputs[r]}/s</span></div>`;
        }
    }

    if(Object.keys(m.outputs).length>0){
        html+=`<div style="margin-top:4px;"><strong>Sorties :</strong></div>`;
        for(const r in m.outputs){
            html+=`<div class="row"><span>${r}</span><span>${m.outputs[r]}/s</span></div>`;
        }
    }

    html+=`<div style="margin-top:4px;" class="row"><span>Pollution</span><span>${m.pollution}</span></div>`;
    html+=`<div class="row"><span>Maintenance</span><span>${state.maintenance.toFixed(0)}%</span></div>`;

    tooltip.innerHTML=html;
    tooltip.style.display="block";

    const x=event.clientX+12;
    const y=event.clientY+12;
    tooltip.style.left=x+"px";
    tooltip.style.top=y+"px";
}

function hideMachineTooltip(){
    tooltip.style.display="none";
}

/* ============================================================
   LANCEMENT
   ============================================================ */

buildGrid();
updateQuests();
requestAnimationFrame(gameLoop);
</script>
</body>
</html>
